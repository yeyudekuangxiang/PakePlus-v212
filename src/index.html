<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习计划与打卡统计助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Heiti TC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* 顶部第一板块 */
        .header-top {
            background: linear-gradient(135deg, #2c5aa0, #4b6bbe);
            color: white;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-top h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-top p {
            font-size: 12px;
        }

        /* 顶部第二板块 */
.header-stats {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    column-gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
       display: flex;
    flex-direction: column;
 align-items: center;
    background: white;
    border-radius: 12px;
    padding: 8px 4px 1px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-label {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    margin-bottom: 1px;
    order: 1;
}

.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #4b6bbe;
    order: 2;
    display: inline-block;
    margin-bottom: 0;
}

.stat-icon {
    font-size: 25px;
    color: #4b6bbe;
    order: 2; 
    display: inline-block;
    margin-left: 5px; 
    margin-top: 0;
}

        /* 中间部分 */
        .middle-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* 计划模板竖排文字 */
        .template-label {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            background: white;
            border-radius: 12px;
            padding: 15px 5px;
            font-size: 16px;
            font-weight: bold;
            color: #4b6bbe;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            height: fit-content;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 右侧内容区域 */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* 学习计划头部 */
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .plan-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
        }

        .btn-batch {
            background: #63c5e0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-add {
            background: #4b6bbe;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
 font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 周视图头部 */
        .week-header {
            background: #eff8ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-title {
            font-size: 18px;
            font-weight: bold;
            color: #4b6bbe;
        }

        .week-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-controls select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .week-controls .btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 自定义时间选择器 */
        .custom-time-selector {
            display: flex;
            align-items: center;
            background: #fd9400;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            gap: 8px;
            cursor: pointer;
        }

        .custom-time-selector i {
            font-size: 13px;
        }

        /* 日历按钮 */
        .calendar-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 周视图日历 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .calendar-day {
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #d4e3f8;
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.today {
            background: #fd9400;
            color: white;
        }

        .calendar-day.selected {
            background: #4b6bbe;
            color: white;
        }

        .calendar-day.checked {
            background: #8bb3f2;
            color: white;
        }

        .weekday {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 0;
        }

        .date {
            font-size: 16px;
            font-weight: bold;
        }

        /* 计划项列表 */
        .plan-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .plan-item {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        /* 科目区域 - 宽度调整为30px，字体加粗 */
        .plan-subject {
            width: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            padding: 15px 0;
        }

        .plan-subject.english {
            background: linear-gradient(to bottom, #c690ce, #a56cb5);
        }

        .plan-subject.chinese {
            background: linear-gradient(to bottom, #99ddae, #7bc593);
        }

        .plan-subject.math {
            background: linear-gradient(to bottom, #f79d82, #e88568);
        }

        .plan-subject.sports {
            background: linear-gradient(to bottom, #6ac9e0, #4bb3d3);
        }

        .plan-subject.relax {
            background: linear-gradient(to bottom, #ff5252, #d32f2f);
        }

        .plan-subject.skill {
            background: linear-gradient(to bottom, #debbb3, #c9a199);
        }

        .plan-subject.other {
            background: linear-gradient(to bottom, #5f7ebe, #4b6bbe);
        }

        /* 计划内容区域 - 调整内边距 */
        .plan-content {
            flex: 1;
            padding: 6px 6px 1px; 
            background: #e0f8e8;
            margin-right: 0;
            border-right: 1px solid #d1d9e6;
            position: relative;
            height: 120px;
        }

        .plan-item.running .plan-content {
            background: white;
        }

        .plan-item.completed .plan-content {
            background: #e0f8e8;
        }

        /* 优化计划头部布局 - 确保在一行显示 */
        .plan-header-row {
            display: flex;
            align-items: center;
            gap: 20px; 
            margin-bottom: 1px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 3px;
        }

        .plan-name {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            font-family: "黑体", sans-serif;
            border: none;
            background: transparent;
            outline: none;
            min-width: 70px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .plan-repeat {
            font-size: 15px;
            color: #4b6bbe;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        .plan-time {
            font-size: 15px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        .plan-actual-time {
            font-size: 15px;
            color: #ff0000;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        /* 计划用时输入框样式 */
        .planned-duration {
            font-size: 15px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 4px;
            background: white;
            width: 66px;
        }

        /* 计划用时标签样式 */
        .duration-label {
            font-size: 15px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
            width: 60px;
        }

        /* 内容文本框背景色 - 调整内边距 */
        .plan-desc {
            font-size: 15px;
            color: #333;
            margin-bottom: 0.5px;
            font-family: "黑体", sans-serif;
            border: 1px solid #ddd;
            padding: 6px; 
            border-radius: 4px;
            min-height: 25px;
            resize: vertical;
            width: 100%;
            background: #f9f9f9;
        }

        /* 详情页跳转区域 */
        .detail-jump-area {
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #4b6bbe;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-bottom: 0.5px; 
            font-size: 0;
        }

        .detail-jump-area i {
            font-size: 0;
        }

        .detail-jump-area span {
            font-size: 0;
        }

        .detail-jump-area:hover {
            background: #f0f4f8;
            border-radius: 4px;
        }

        /* 计时/完成状态区域 */
        .plan-status {
            width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: #f0f4f8;
        }

        .timer-display {
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 22px;
            font-weight: bold;
            background: white;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
            padding: 0 5px;
        }

        .timer-display.timing {
            color: #e1443b;
            font-size: 22px;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
        }

        .timer-display.completed {
            color: #28a745;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
        }

    .timer-display.canceled {
        color: #dc3545;
        font-size: 22px;
        font-family: 'Courier New', Courier, monospace;
        letter-spacing: 0.8px;
    }

        .timer-controls {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .timer-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .timer-btn.start {
            background: #26b563;
        }

        .timer-btn.pause {
            background: #f8d287;
        }

        .timer-btn.stop {
            background: #e1443b;
        }

        .timer-btn.cancel {
            background: #764A94;
        }

        .completed-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #28a745;
            color: white;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            gap: 5px;
            width: 70%;
            min-width: 70px;
        }

        .completed-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            color: #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .canceled-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #dc3545;
            color: white;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            gap: 5px;
            width: 70%;
            min-width: 70px;
        }

        .canceled-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            color: #dc3545;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* 底部区域 */
        .data-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .data-actions .btn {
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #backup-btn {
            background: #28a745;
        }

        #import-btn {
            background: #6f42c1;
        }

        #clear-btn {
            background: #dc3545;
        }

        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 12px;
            color: #999;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* 时间选择器样式 */
        .time-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-picker {
            display: flex;
            align-items: center;
            background: #fd9400;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            gap: 8px;
            cursor: pointer;
            flex: 1;
            justify-content: center;
        }

        .time-picker i {
            font-size: 13px;
        }

        .time-range-display {
            display: flex;
            align-items: center;
            background: #f0f8ff;
            border: 1px solid #cce5ff;
            border-radius: 6px;
            padding: 10px;
            flex: 1;
            justify-content: center;
            font-weight: bold;
            color: #4b6bbe;
        }

        .time-range-display span {
            margin: 0 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions .btn {
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-save {
            background: #4b6bbe;
            color: white;
            border: none;
        }

        /* 批量添加模态框 */
        .batch-input {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        /* 数据管理模态框 */
        .data-import {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        .backup-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            color: #4b6bbe;
        }

        /* 详情页面模态框样式 */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 15px;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #496db9;
            width: 80px;
            justify-content: center;
        }
        
        .detail-actions {
            display: flex;
            gap: 15px;
        }
        
        .detail-action-btn {
            background: none;
            border: none;
            color: #496db9;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 0;
            transition: color 0.2s;
        }
        
        .detail-action-btn:hover {
            color: #2c5aa0;
        }
        
        .plan-title-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }
        
        /* 修改详情页计划名称和重复频率布局 */
        .plan-name-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .plan-name-large {
            font-size: 50px;
            color: #496db9;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold; 
            letter-spacing: 1px; 
            position: relative;
            padding-bottom: 10px;
        }
        
        .repeat-badge {
            background-color: #cfedf3;
            color: #496db9;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            position: absolute;
            right: -20px;
            bottom: 0;
            transform: translateX(100%);
            white-space: nowrap;
            font-family: 'Courier New', Courier, monospace; 
            font-weight: bold; 
            letter-spacing: 0.5px; 
        }
        
        .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f5f7fa;
            border-radius: 12px;
        }
        
        /* 修改详情页计时器字体为等宽字体，加粗 */
        .detail-timer-display {
            font-size: 120px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            width: auto;
            font-family: 'Courier New', monospace;
            font-weight: 900;
            letter-spacing: 1px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .detail-timer-display.timing {
            color: #e1443b;
        }
        
        .detail-timer-display.completed {
            color: #28a745;
        }

    .detail-timer-display.canceled {
        color: #dc3545;
    }
        
        .detail-timer-controls {
            display: flex;
            gap: 25px;
        }
        
        /* 详情页计时器按钮样式调整 */
        .detail-timer-btn {
            display: flex;
            align-items: center;
            gap: 8px; 
            color: white;
            border: none;
            padding: 8px 16px; 
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .detail-timer-btn i {
            font-size: 18px; 
            color: white; 
            vertical-align: middle; 
        }

        .detail-timer-btn:hover {
            transform: scale(1.05); 
        }

        .detail-timer-btn.start {
            background-color: #26b563;
        }

        .detail-timer-btn.pause {
            background-color: #f8d287;
        }

        .detail-timer-btn.stop {
            background-color: #e1443b;
        }
        
         .detail-timer-btn.cancel {
            background: #764A94;
        }

        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .info-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            color: #496db9;
            font-weight: bold;
        }

        .info-title i {
            font-size: 18px;
        }
        
        .info-content {
            font-size: 16px;
            color: #333;
        }
        
        .description-section {
            margin-bottom: 25px;
        }
        
        .description-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .description-content {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            font-family: "黑体", sans-serif;
            font-size: 16px;
            resize: vertical;
            width: 100%;
        }

        /* 全年日历模态框样式 */
        .year-calendar {
            max-width: 600px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .calendar-grid-year {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: #4b6bbe;
        }

        .calendar-day-year {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .calendar-day-year:hover {
            background: #e6f0ff;
        }

        .calendar-day-year.today {
            background: #fd9400;
            color: white;
        }

        .calendar-day-year.selected {
            background: #4b6bbe;
            color: white;
        }

        .calendar-day-year.other-month {
            color: #ccc;
        }

         /* 新增样式：禁用状态 */
                .timer-btn.disabled {
                    background: #ccc !important;
                    cursor: not-allowed;
                }
        
                .plan-item.disabled .timer-btn {
                    background: #ccc !important;
                    cursor: not-allowed;
                }

         /* 统计图表详情页样式 */
         .stats-detail-modal {
             display: none;
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: white;
             z-index: 2000;
             overflow-y: auto;
            padding: 20px;
         }

         .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
        }

        .stats-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }

        .stats-title i {
            font-size: 22px;
            color: #4b6bbe;
        }

        .date-filter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 35px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 12px;
            flex-wrap: wrap;
 max-width: 75%;
    margin-left: auto;
    margin-right: auto;
        }

        .date-filter-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .date-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding:8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            background: white;
            min-width: 120px;
            justify-content: center;
            cursor: pointer;
        }

        .date-input i {
            font-size: 14px;
            color: #4b6bbe;
        }

     .filter-btn {
            background-color: #496db9;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
justify-content: center; 
            gap: 8px;
            transition: background-color 0.3s ease;
            min-width: 60px; 
            max-width: 80px; 
            width: auto;
 height: 35px;
        }

        .filter-btn:hover {
            background-color: #3a5a9e;
        }

        /* 图表容器样式 - 增大尺寸 */
.chart-container {
    width: 100%;
    height: 400px; /* 增大高度 */
    margin-bottom: 30px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    padding: 10px 20px;
    position: relative;
display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
}

.chart-container > div {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
}

.chart-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
    text-align: center;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
    width: 100%;
}

/* 响应式布局 */
@media (max-width: 1200px) {
    .stats-title {
        font-size: 24px;
    }
    
    .date-filter-container {
        gap: 15px;
    }
    
    .date-input {
        padding: 8px;
        font-size: 14px;
        min-width: 110px;
    }

    .filter-btn {
        padding: 15x;
        font-size: 14px;
    }
 }

@media (max-width: 768px) {
    .stats-detail-modal {
        padding: 15px;
    }
    
    .stats-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .stats-title {
        font-size: 22px;
    }
    
    .date-filter-container {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .date-filter-label {
        text-align: center;
    }
    
    .date-input {
        justify-content: center;
    }
    
    .chart-container {
        height: 350px;
        padding: 15px;
        margin-bottom: 30px;
    }
    
    .chart-title {
        font-size: 18px;
    }

    .filter-btn {
        padding: 10px; 
        height: 32px;
        min-width: 65px;
        max-width: 80px;
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .stats-detail-modal {
        padding: 10px;
    }
    
    .stats-title {
        font-size: 20px;
        gap: 10px;
    }
    
    .stats-title i {
        font-size: 20px;
    }
    
    .date-filter-container {
        padding: 15px;
    }
    
    .chart-container {
        height: 300px;
        padding: 12px;
        margin-bottom: 25px;
    }
    
    .chart-title {
        font-size: 16px;
    }
}

        /* 确保ECharts图表自适应容器 */
        .echarts {
            width: 100% !important;
            height: 100% !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 修改图表容器内的canvas样式 */
        .chart-container canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* 关闭按钮样式优化 */
        .stats-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .stats-close-btn:hover {
            background-color: #f0f0f0;
        }

 /* 计划用时与实际用时对比图表的日期筛选区域 - 强制减小高度 */
.plan-actual-date-filter {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 20px !important; 
    margin-bottom: 15px !important; 
    padding: 10px !important; 
    background-color: #f9f9f9 !important;
    border-radius: 12px !important; 
    flex-wrap: wrap !important;
    height: 60px !important; 
    max-width: 60% !important;
    margin-left: auto !important;
    margin-right: auto !important;
    position: relative !important;
    z-index: 10 !important;
}

.plan-actual-date-label {
    font-size: 16px !important; /* 减小字体大小 */
    font-weight: bold !important;
    color: #333 !important;
    line-height: 1 !important;
    margin: 0 !important;
    padding: 0 !important;
}

.plan-actual-date-input {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important; /* 减小间隙 */
    padding: 15px !important; /* 减小内边距 */
    border: 1px solid #ddd !important;
    border-radius: 8px !important; /* 减小圆角 */
    font-size: 14px !important; /* 减小字体大小 */
    font-weight: bold !important;
    background: white !important;
    min-width: 100px !important; /* 可适当减小最小宽度 */
    justify-content: center !important;
    cursor: pointer !important;
    height: 30px !important; /* 减小高度 */
    line-height: 1 !important;
    margin: 0 !important;
}

.plan-actual-date-input i {
    font-size: 14px !important; /* 减小图标大小 */
    color: #4b6bbe !important;
}

.plan-actual-filter-btn {
    background-color: #496db9 !important;
    color: white !important;
    border: none !important;
    padding:15px !important;
    border-radius: 8px !important; /* 从8px减小到4px */
    font-size: 14px !important; 
    font-weight: bold !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important; 
    transition: background-color 0.3s ease !important;
    height: 30px !important; 
    line-height: 1 !important;
    margin: 0 !important;
}

.plan-actual-filter-btn:hover {
    background-color: #3a5a9e !important;
}

        /* 全年日历模态框样式 - 用于计划用时筛选 */
        .plan-actual-calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .plan-actual-calendar-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

/* 统计图表日期筛选日历样式 */
        .stats-date-calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .stats-date-calendar-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stats-date-calendar-modal .calendar-nav-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stats-date-calendar-modal .calendar-month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .stats-date-calendar-modal .calendar-grid-year {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .stats-date-calendar-modal .calendar-weekday {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: #4b6bbe;
        }
        
        .stats-date-calendar-modal .calendar-day-year {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .stats-date-calendar-modal .calendar-day-year:hover {
            background: #e6f0ff;
        }
        
        .stats-date-calendar-modal .calendar-day-year.today {
            background: #fd9400;
            color: white;
        }
        
        .stats-date-calendar-modal .calendar-day-year.selected {
            background: #4b6bbe;
            color: white;
        }
        
        .stats-date-calendar-modal .calendar-day-year.other-month {
            color: #ccc;
        }

/* 荣誉勋章墙模态框样式 */
        .honor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .honor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
        }
        
        .honor-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }
        
        .honor-title i {
            font-size: 22px;
            color: #4b6bbe;
        }
        
        .honor-actions {
            display: flex;
            gap: 15px;
        }
        
        .honor-action-btn {
            background: none;
            border: none;
            color: #496db9;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 6px;
            transition: all 0.2s ease;
           }
        
        .honor-action-btn:hover {
            background-color: #496db9;
            color: white;
        }

/* 新增：主要操作按钮容器 */
.honor-main-actions {
    display: flex;
   justify-content: flex-start;
align-items: center; 
    gap: 15px;
    margin-bottom: 15px;
}

/* 新增：主要操作按钮样式 */
.honor-main-btn {
    background: #4b6bbe;
    color: white;
    border: none;
    padding: 8px ;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.honor-main-btn:hover {
    background: #3a5a9e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

#clear-honor-btn {
    background: #dc3545;
    color: white;
}

.honor-main-btn i {
    font-size: 14px;
}
      
/* 单独设置添加兑换清单按钮 */
#add-wish-btn {
    background: #4b6bbe; 
    font-size: 14px;  
color: white;
   font-weight: bold;
padding: 8px;
border: none;
}

#add-wish-btn:hover {
    background:  #4b6bbe; 
}

/* 单独设置清空兑换清单按钮 */
#clear-wish-btn {
    background: #dc3545; 
    font-size: 14px;   
 color: white;
font-weight: bold;
padding: 8px;
border: none;
}

#clear-wish-btn:hover {
    background: #dc3545; /* 悬停时深红色 */
}

         .honor-section {
            margin-bottom: 30px;
        }
        
        .honor-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .honor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
      .honor-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    padding: 25px 20px;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

        .honor-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff);
    background-size: 200% 100%;
    animation: shimmer 3s infinite linear;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.honor-card.locked {
    background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
    filter: grayscale(0.8);
    opacity: 0.7;
}
        
.honor-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}
        
.honor-card.locked:hover {
    transform: translateY(-5px) scale(1.01);
    filter: grayscale(0.6);
    opacity: 0.9;
}

.honor-icon {
    font-size: 48px;
    margin-bottom: 20px;
    position: relative;
    display: inline-block;
    transition: all 0.3s ease;
}

.honor-card:hover .honor-icon {
    transform: scale(1.1) rotate(5deg);
}

.honor-card.locked:hover .honor-icon {
    transform: scale(1.05);
}
        
.honor-name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #2c3e50;
    position: relative;
    padding-bottom: 8px;
}

.honor-name::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 25%;
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4b6bbe, transparent);
}
        
.honor-description {
    font-size: 14px;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
        
     .honor-progress {
    font-size: 12px;
    color: #4b6bbe;
    font-weight: bold;
    padding: 6px 12px;
    background: rgba(75, 107, 190, 0.1);
    border-radius: 20px;
    display: inline-block;
}

.honor-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, #4b6bbe, #6b8cff);
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 3px 10px rgba(75, 107, 190, 0.3);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

      /* 许愿星兑换板块样式 */
        .wish-section {
            background-color: #f0f8ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .wish-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .wish-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .wish-stars {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #fd9400;
        }
        
        .wish-stars i {
            font-size: 20px;
        }
        
        .wish-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .wish-category-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .wish-category-btn.active {
            background-color: #4b6bbe;
            color: white;
            border-color: #4b6bbe;
        }
        
/* 新增：兑换清单操作按钮容器 */
.wish-actions {
    display: flex;
    justify-content: flex-start;
    gap: 15px;
    margin-bottom: 15px;
}

        .wish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
.wish-item {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
    border-radius: 16px;
    padding: 25px 20px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
}
        
.wish-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #ff9a9e);
    background-size: 200% 100%;
    animation: shimmer 3s infinite linear;
}
      
.wish-item.disabled {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    filter: grayscale(0.8);
    opacity: 0.6;
}
        
.wish-item:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}

.wish-item.disabled:hover {
    transform: translateY(-5px) scale(1.01);
    filter: grayscale(0.6);
    opacity: 0.8;
}

.wish-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
        
.wish-item-category {
    font-size: 12px;
    color: #fff;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
        
.wish-item[data-category="entertainment"] .wish-item-category {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
}

.wish-item[data-category="food"] .wish-item-category {
    background: linear-gradient(135deg, #ffa726, #ffb74d);
}

.wish-item[data-category="shopping"] .wish-item-category {
    background: linear-gradient(135deg, #4b6bbe, #6b8cff);
}

.wish-item[data-category="experience"] .wish-item-category {
    background: linear-gradient(135deg, #66bb6a, #81c784);
}

.wish-item-status {
    font-size: 11px;
    color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
}

.wish-item-name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #2c3e50;
    position: relative;
    padding-bottom: 8px;
}
      
.wish-item-name::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 40px;
    height: 2px;
    background: linear-gradient(90deg, #ffd93d, transparent);
}
  
.wish-item-description {
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
    line-height: 1.5;
}
        
.wish-item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

        .wish-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
.wish-item-cost {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 18px;
    font-weight: bold;
    color: #fd9400;
    padding: 6px 12px;
    background: rgba(253, 148, 0, 0.1);
    border-radius: 20px;
}
        
.wish-item-cost i {
    font-size: 20px;
    animation: sparkle 2s infinite;
}

        @keyframes sparkle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

        .wish-item-btn {
    background: linear-gradient(135deg, #4b6bbe, #6b8cff);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(75, 107, 190, 0.3);
    position: relative;
    overflow: hidden;
}
        
.wish-item-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.wish-item-btn:hover::before {
    left: 100%;
}

.wish-item-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #3a5a9e, #5a7ae8);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(75, 107, 190, 0.4);
}
        
.wish-item-btn:disabled {
    background: linear-gradient(135deg, #bdc3c7, #95a5a6);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* 为兑换清单添加悬停效果 */
.wish-item:hover .wish-item-cost {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}
       
/* 响应式调整 */
@media (max-width: 768px) {
    .honor-card, .wish-item {
        padding: 20px 15px;
    }
    
    .honor-icon {
        font-size: 40px;
    }
    
    .wish-item-name {
        font-size: 16px;
    }
}

        /* 添加勋章模态框样式 */
        .add-honor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .add-honor-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        /* 添加兑换清单模态框样式 */
        .add-wish-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .add-wish-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- 顶部第一板块 -->
    <div class="header-top">
        <h1>学习计划与打卡统计助手</h1>
        <p>你已坚持打卡<span id="streak-days">0</span>天，已累计完成<span id="total-plans">0</span>个学习计划！</p>
    </div>

    <!-- 顶部第二板块 -->
    <div class="header-stats">
                <div class="stat-card">
            <div class="stat-label">今日学习时间</div>
            <div class="stat-value" id="today-study-time">0h</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">今日运动时间</div>
            <div class="stat-value" id="today-sports-time">0h</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">今日任务数量</div>
            <div class="stat-value" id="today-tasks">0/0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">今日完成率</div>
            <div class="stat-value" id="today-completion">0%</div>
        </div>
    <!-- 新增统计卡片 -->
    <div class="stat-card" id="stats-chart-card">
        <div class="stat-label">统计图表汇总</div>
        <div class="stat-value"></div>
        <div class="stat-icon">
            <i class="fas fa-chart-pie"></i>
        </div>
    </div>
     <div class="stat-card" id="honor-wall-card">
            <div class="stat-label">荣誉勋章墙</div>
            <div class="stat-value"></div>
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
        </div>
    </div>
</div>

    <!-- 中间部分 -->
    <div class="middle-section">
        <!-- 左侧计划模板 -->
        <div class="template-label">
            <i class="fas fa-clipboard-list"></i> 计划模版
        </div>

        <!-- 右侧内容区域 -->
        <div class="content-area">
            <!-- 学习计划头部 -->
            <div class="plan-header">
                <div class="plan-title">
                    <i class="fas fa-book"></i> 学习计划
                </div>
                <div class="plan-actions">
                    <button class="btn-batch" id="batch-add-btn">
                        <i class="fas fa-layer-group"></i> 批量添加
                    </button>
                    <button class="btn-add" id="add-plan-btn">
                        <i class="fas fa-plus"></i> 添加计划
                    </button>
                </div>
            </div>

            <!-- 周视图头部 -->
            <div class="week-header">
                <div class="week-title" id="week-title"></div>
                <div class="week-controls">
                    <button class="btn" id="prev-week-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="custom-time-selector" id="today-btn">
                        <i class="fas fa-calendar"></i>
                        <span>今天</span>
                    </div>
                    <button class="btn" id="next-week-btn"><i class="fas fa-chevron-right"></i></button>
                    <button class="calendar-btn" id="full-calendar-btn">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
            </div>

            <!-- 周视图日历 -->
            <div class="calendar-grid" id="calendar-grid">
                <!-- 日历将通过JS动态生成 -->
            </div>

            <!-- 计划项列表 -->
            <div class="plan-list" id="plan-list">
                <!-- 计划项将通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 底部区域 -->
    <div class="data-actions">
        <button class="btn" id="backup-btn">
            <i class="fas fa-save"></i> 备份数据
        </button>
        <button class="btn" id="import-btn">
            <i class="fas fa-file-import"></i> 导入数据
        </button>
        <button class="btn" id="clear-btn">
            <i class="fas fa-trash"></i> 清空学习计划
        </button>
    </div>

    <div class="footer">
        学习计划与打卡统计助手 | 设计原则：劳逸结合·科学规划·快乐学习
    </div>

    <!-- 添加计划模态框 -->
    <div class="modal" id="add-plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加学习计划</div>
                <button class="close-btn" id="close-add-plan-modal">&times;</button>
            </div>
            <form id="add-plan-form">
                <div class="form-group">
                    <label for="plan-subject">科目</label>
                    <select id="plan-subject" class="form-control" required>
                        <option value="">选择科目</option>
                        <option value="english">英语</option>
                        <option value="chinese">语文</option>
                        <option value="math">数学</option>
                        <option value="sports">运动</option>
                        <option value="relax">放松</option> 
                        <option value="skill">技能</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plan-name">计划名称</label>
                    <input type="text" id="plan-name" class="form-control" placeholder="例如：星火英语" required>
                </div>
                <div class="form-group">
                    <label for="planned-duration">计划用时</label>
                    <input type="text" id="planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="plan-repeat">重复频率</label>
                    <select id="plan-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plan-description">计划内容</label>
                    <textarea id="plan-description" class="form-control" rows="3" placeholder="描述你的学习内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-plan">取消</button>
                    <button type="submit" class="btn btn-save">保存计划</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 批量添加模态框 -->
    <div class="modal" id="batch-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">批量添加计划</div>
                <button class="close-btn" id="close-batch-add-modal">&times;</button>
            </div>
            <form id="batch-add-form">
                <div class="form-group">
                    <label for="batch-input">批量输入计划</label>
                    <textarea id="batch-input" class="batch-input" placeholder="例如:
语文
1.完成《大青树下的小学》阅读单
2.预习《花的学校》
数学
1.完成练习册第10页
2.预习下一节"></textarea>
                </div>
                <div class="form-group">
                    <label for="batch-planned-duration">计划用时</label>
                    <input type="text" id="batch-planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="batch-repeat">重复频率</label>
                    <select id="batch-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-batch-add">取消</button>
                    <button type="submit" class="btn btn-save">批量添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 备份数据模态框 -->
    <div class="modal" id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">备份数据</div>
                <button class="close-btn" id="close-backup-modal">&times;</button>
            </div>
            <div class="backup-info">
                <p>您的学习数据已成功备份！</p>
                <p>备份时间：<span id="backup-time"></span></p>
                <p>备份内容：学习计划、打卡记录、统计信息</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="close-backup">关闭</button>
                <button type="button" class="btn btn-save" id="download-backup">下载备份文件</button>
            </div>
        </div>
    </div>

    <!-- 导入数据模态框 -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">导入数据</div>
                <button class="close-btn" id="close-import-modal">&times;</button>
            </div>
            <form id="import-form">
                <div class="form-group">
                    <label for="data-import">粘贴备份数据</label>
                    <textarea id="data-import" class="data-import" placeholder="请粘贴之前备份的数据"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-import">取消</button>
                    <button type="submit" class="btn btn-save">导入数据</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 清空数据确认模态框 -->
    <div class="modal" id="clear-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">确认清空</div>
                <button class="close-btn" id="close-clear-modal">&times;</button>
            </div>
            <p>您确定要清空所有学习计划吗？此操作不可撤销！</p>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-clear">取消</button>
                <button type="button" class="btn btn-save" id="confirm-clear">确认清空</button>
            </div>
        </div>
    </div>

    <!-- 编辑计划模态框 -->
    <div class="modal" id="edit-plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑学习计划</div>
                <button class="close-btn" id="close-edit-plan-modal">&times;</button>
            </div>
            <form id="edit-plan-form">
                <div class="form-group">
                    <label for="edit-plan-subject">科目</label>
                    <select id="edit-plan-subject" class="form-control" required>
                        <option value="">选择科目</option>
                        <option value="english">英语</option>
                        <option value="chinese">语文</option>
                        <option value="math">数学</option>
                        <option value="sports">运动</option>
                        <option value="relax">放松</option>
                        <option value="skill">技能</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-plan-name">计划名称</label>
                    <input type="text" id="edit-plan-name" class="form-control" placeholder="例如：星火英语" required>
                </div>
                <div class="form-group">
                    <label for="edit-planned-duration">计划用时</label>
                    <input type="text" id="edit-planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="edit-plan-repeat">重复频率</label>
                    <select id="edit-plan-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-plan-description">计划内容</label>
                    <textarea id="edit-plan-description" class="form-control" rows="3" placeholder="描述你的学习内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-edit-plan">取消</button>
                    <button type="submit" class="btn btn-save">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 详情页面模态框 -->
    <div class="detail-modal" id="detail-modal">
        <div class="detail-header">
            <button class="back-btn" id="back-btn">
                <i class="fas fa-arrow-left"></i>
                返回
            </button>
            <div class="detail-actions">
                <button class="detail-action-btn" id="edit-btn">
                    <i class="fas fa-edit"></i>
                    编辑
                </button>
                <button class="detail-action-btn" id="delete-btn">
                    <i class="fas fa-trash"></i>
                    删除
                </button>
            </div>
        </div>
        
        <div class="plan-title-section">
            <div class="plan-name-container">
                <div class="plan-name-large" id="detail-plan-name">
                    <i class="fas fa-book"></i> 目作文
                    <div class="repeat-badge" id="detail-repeat">重复频率：仅当天</div>
                </div>
            </div>
        </div>
        
        <div class="timer-section">
            <div class="detail-timer-display" id="detail-timer">00:00:00</div>
            <div class="detail-timer-controls">
                <button class="detail-timer-btn start" id="detail-start-btn">
        <i class="fas fa-play"></i> 开始
    </button>
    <button class="detail-timer-btn stop" id="detail-stop-btn">
        <i class="fas fa-stop"></i> 结束
    </button>
    <button class="detail-timer-btn cancel" id="detail-cancel-btn">
        <i class="fas fa-times"></i> 取消
    </button>
</div>
        </div>
        
        <div class="info-section">
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-book"></i>
                    任务分类
                </div>
                <div class="info-content" id="detail-subject">语文</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-clock"></i>
                    计划用时
                </div>
                 <div class="info-content" id="detail-planned-duration">30min</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-calendar"></i>
                    任务日期
                </div>
                <div class="info-content" id="detail-date">2025-10-08</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-history"></i>
                    实际时间
                </div>
                <div class="info-content" id="detail-actual-time">14:26 - 进行中</div>
            </div>
        </div>
        
        <div class="description-section">
            <div class="description-title">
                <i class="fas fa-file-alt"></i>
                任务说明
            </div>
            <textarea class="description-content" id="detail-description">分) 请你选择国庆假期中记忆较深的一天写一篇日记，写出自己在这一天中的所言、所行、所见、所闻和所感，注意日记的格式。</textarea>
        </div>
    </div>

  <!-- 统计图表详情页模态框 -->
<div class="stats-detail-modal" id="stats-detail-modal">
    <div class="stats-header">
        <div class="stats-title">
            <i class="fas fa-chart-bar"></i>
            学习数据统计详情
        </div>
        <button class="back-btn" id="stats-back-btn">
            <i class="fas fa-arrow-left"></i>
            返回
        </button>
    </div>
    
    <!-- 日期筛选区域 -->
     <div class="date-filter-container">
        <div class="date-filter-label">统计时间范围：</div>
        <div class="date-input" id="start-date">
            <i class="fas fa-calendar"></i>
               <span id="start-date-display">2025/10/01</span>
        </div>
        <span>至</span>
        <div class="date-input" id="end-date">
            <i class="fas fa-calendar"></i>
             <span id="end-date-display">2025/10/15</span>
        </div>
        <button class="filter-btn" id="stats-filter-btn">
            筛选
        </button>
    </div>
    
    <!-- 图表容器 -->
    <div class="chart-container">
           <div id="completion-chart" style="width: 100%; height: 100%;"></div>
    </div>
    
    <div class="chart-container">
           <div id="time-comparison-chart" style="width: 100%; height: 100%;"></div>
    </div>
    
    <div class="chart-container">
          <div id="category-pie-chart" style="width: 100%; height: 100%;"></div>
    </div>
    
                  <!-- 新增的日期筛选区域 -->
            <div class="plan-actual-date-filter">
                <div class="plan-actual-date-label">选择日期：</div>
                <div class="plan-actual-date-input" id="plan-actual-date-input">
                    <i class="fas fa-calendar"></i>
                    <span id="plan-actual-date-display">选择日期</span>
            </div>
                <button class="plan-actual-filter-btn" id="plan-actual-filter-btn">
                    筛选
                </button>
            </div>
            
    <div class="chart-container">
            <div id="plan-vs-actual-chart" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
    
    <!-- 新增的全年日历模态框 - 用于计划用时筛选 -->
    <div class="plan-actual-calendar-modal" id="plan-actual-calendar-modal">
        <div class="plan-actual-calendar-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-plan-actual-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="plan-actual-prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="plan-actual-calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="plan-actual-next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="plan-actual-calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-plan-actual-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-plan-actual-calendar">确定</button>
            </div>
        </div>
    </div>

<!-- 统计图表日期筛选日历模态框 -->
    <div class="stats-date-calendar-modal" id="stats-date-calendar-modal">
        <div class="stats-date-calendar-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-stats-date-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="stats-date-prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="stats-date-calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="stats-date-next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="stats-date-calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-stats-date-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-stats-date-calendar">确定</button>
            </div>
        </div>
    </div>

    <!-- 全年日历模态框 -->
    <div class="modal" id="full-calendar-modal">
        <div class="modal-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-full-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-full-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-full-calendar">确定</button>
            </div>
        </div>
</div>

 <!-- 荣誉勋章墙模态框 -->
    <div class="honor-modal" id="honor-modal">
        <div class="honor-header">
            <div class="honor-title">
                <i class="fas fa-trophy"></i>
                荣誉勋章墙
           </div>
        <div class="honor-actions">
            <button class="back-btn" id="honor-back-btn">
                <i class="fas fa-arrow-left"></i>
                返回
            </button>
        </div>
    </div>

 <!-- 新增：勋章操作按钮区域 -->
    <div class="honor-main-actions">
        <button class="honor-main-btn" id="add-honor-btn">
            <i class="fas fa-plus"></i>
            添加勋章
        </button>
        <button class="honor-main-btn" id="clear-honor-btn">
            <i class="fas fa-trash"></i>
            清空勋章
        </button>
    </div>
        
        <!-- 连续打卡成就 -->
        <div class="honor-section">
            <div class="honor-section-title">连续打卡成就</div>
            <div class="honor-grid" id="streak-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 累计打卡成就 -->
        <div class="honor-section">
            <div class="honor-section-title">累计打卡成就</div>
            <div class="honor-grid" id="total-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 分类打卡成就 -->
        <div class="honor-section">
            <div class="honor-section-title">分类打卡成就</div>
            <div class="honor-grid" id="category-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 时间管理成就 -->
        <div class="honor-section">
            <div class="honor-section-title">时间管理成就</div>
            <div class="honor-grid" id="time-management-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 总学习时间成就 -->
        <div class="honor-section">
            <div class="honor-section-title">总学习时间成就</div>
            <div class="honor-grid" id="total-study-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 提前完成成就 -->
        <div class="honor-section">
            <div class="honor-section-title">提前完成成就</div>
            <div class="honor-grid" id="early-completion-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 许愿星兑换板块 -->
        <div class="wish-section">
            <div class="wish-header">
                <div class="wish-title">许愿星兑换</div>
                <div class="wish-stars">
                    <i class="fas fa-star"></i>
                    <span id="available-stars">0</span>
                </div>
            </div>
            
            <div class="wish-categories">
                <button class="wish-category-btn active" data-category="all">全部</button>
                <button class="wish-category-btn" data-category="entertainment">娱乐活动</button>
                <button class="wish-category-btn" data-category="food">美食饮品</button>
                <button class="wish-category-btn" data-category="shopping">购物奖励</button>
                <button class="wish-category-btn" data-category="experience">体验活动</button>
            </div>
            
            <div class="wish-actions">
                <button class="honor-action-btn" id="add-wish-btn">
                    <i class="fas fa-plus"></i>
                    添加兑换清单
                </button>
                <button class="honor-action-btn" id="clear-wish-btn">
                    <i class="fas fa-trash"></i>
                    清空兑换清单
                </button>
            </div>
            
            <div class="wish-grid" id="wish-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 添加勋章模态框 -->
    <div class="add-honor-modal" id="add-honor-modal">
        <div class="add-honor-content">
            <div class="modal-header">
                <div class="modal-title">添加勋章</div>
                <button class="close-btn" id="close-add-honor-modal">&times;</button>
            </div>
            <form id="add-honor-form">
                <div class="form-group">
                    <label for="honor-name">勋章名称</label>
                    <input type="text" id="honor-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="honor-description">勋章描述</label>
                    <textarea id="honor-description" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="honor-icon">选择图标</label>
                    <select id="honor-icon" class="form-control" required>
                        <option value="fas fa-medal">奖牌</option>
                        <option value="fas fa-trophy">奖杯</option>
                        <option value="fas fa-star">星星</option>
                        <option value="fas fa-crown">皇冠</option>
                        <option value="fas fa-award">荣誉</option>
                        <option value="fas fa-gem">宝石</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="honor-color">选择颜色</label>
                    <input type="color" id="honor-color" class="form-control" value="#fd9400" required>
                </div>
                <div class="form-group">
                    <label for="honor-condition">解锁条件</label>
                    <select id="honor-condition" class="form-control" required>
                        <option value="streak">连续打卡天数</option>
                        <option value="total_plans">累计完成计划数</option>
                        <option value="category_hours">分类完成时间(小时)</option>
                        <option value="time_accuracy">时间管理准确率</option>
                        <option value="total_study_hours">总学习时间(小时)</option>
                        <option value="early_completion">提前完成次数</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="honor-value">条件值</label>
                    <input type="number" id="honor-value" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-honor">取消</button>
                    <button type="submit" class="btn btn-save">保存勋章</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加兑换清单模态框 -->
    <div class="add-wish-modal" id="add-wish-modal">
        <div class="add-wish-content">
            <div class="modal-header">
                <div class="modal-title">添加兑换清单</div>
                <button class="close-btn" id="close-add-wish-modal">&times;</button>
            </div>
            <form id="add-wish-form">
                <div class="form-group">
                    <label for="wish-category">兑换类别</label>
                    <select id="wish-category" class="form-control" required>
                        <option value="entertainment">娱乐活动</option>
                        <option value="food">美食饮品</option>
                        <option value="shopping">购物奖励</option>
                        <option value="experience">体验活动</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="wish-content">兑换内容</label>
                    <input type="text" id="wish-content" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="wish-quantity">兑换数量</label>
                    <input type="number" id="wish-quantity" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="wish-cost">所需星星</label>
                    <input type="number" id="wish-cost" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-wish">取消</button>
                    <button type="submit" class="btn btn-save">保存兑换项</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 数据模型
        let plans = JSON.parse(localStorage.getItem('studyPlans')) || [];
        let checkins = JSON.parse(localStorage.getItem('studyCheckins')) || [];
        let currentWeekOffset = 0;
        let selectedDate = new Date();
        let timers = {};
        let currentDetailPlanId = null;
        let currentEditPlanId = null;
        let selectedCalendarDate = null;

        
        // 新增变量 - 用于计划用时筛选
        let selectedPlanActualDate = new Date(); // 默认选中今天
        let selectedPlanActualCalendarDate = null;

   // 新增变量 - 用于统计图表日期筛选
        let selectedStatsStartDate = new Date();
        selectedStatsStartDate.setDate(selectedStatsStartDate.getDate() - 14); // 默认开始日期为14天前
        let selectedStatsEndDate = new Date(); // 默认结束日期为今天
        let selectedStatsCalendarDate = null;
        let currentStatsDateSelection = null; // 'start' 或 'end'


        // 获取DOM元素
        const planList = document.getElementById('plan-list');
        const calendarGrid = document.getElementById('calendar-grid');
        const todayBtn = document.getElementById('today-btn');
        const addPlanBtn = document.getElementById('add-plan-btn');
        const batchAddBtn = document.getElementById('batch-add-btn');
        const backupBtn = document.getElementById('backup-btn');
        const importBtn = document.getElementById('import-btn');
        const clearBtn = document.getElementById('clear-btn');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const weekTitle = document.getElementById('week-title');
        const fullCalendarBtn = document.getElementById('full-calendar-btn');
        const statsChartCard = document.getElementById('stats-chart-card');
        const statsDetailModal = document.getElementById('stats-detail-modal');
        const statsBackBtn = document.getElementById('stats-back-btn');

        // 图表容器
        const completionChart = document.getElementById('completion-chart');
        const timeComparisonChart = document.getElementById('time-comparison-chart');
        const categoryPieChart = document.getElementById('category-pie-chart');
        const planVsActualChart = document.getElementById('plan-vs-actual-chart');

        // 模态框元素
        const addPlanModal = document.getElementById('add-plan-modal');
        const batchAddModal = document.getElementById('batch-add-modal');
        const backupModal = document.getElementById('backup-modal');
        const importModal = document.getElementById('import-modal');
        const clearConfirmModal = document.getElementById('clear-confirm-modal');
        const editPlanModal = document.getElementById('edit-plan-modal');
        const detailModal = document.getElementById('detail-modal');
        const fullCalendarModal = document.getElementById('full-calendar-modal');
        
        // 新增模态框元素 - 用于计划用时筛选
        const planActualCalendarModal = document.getElementById('plan-actual-calendar-modal');
        const planActualDateInput = document.getElementById('plan-actual-date-input');
        const planActualDateDisplay = document.getElementById('plan-actual-date-display');
        const planActualFilterBtn = document.getElementById('plan-actual-filter-btn');
        const closePlanActualCalendarModal = document.getElementById('close-plan-actual-calendar-modal');
        const planActualCalendarMonthYear = document.getElementById('plan-actual-calendar-month-year');
        const planActualCalendarGridYear = document.getElementById('plan-actual-calendar-grid-year');
        const planActualPrevYearBtn = document.getElementById('plan-actual-prev-year-btn');
        const planActualNextYearBtn = document.getElementById('plan-actual-next-year-btn');
        const cancelPlanActualCalendar = document.getElementById('cancel-plan-actual-calendar');
        const confirmPlanActualCalendar = document.getElementById('confirm-plan-actual-calendar');

         // 新增模态框元素 - 用于统计图表日期筛选
        const statsDateCalendarModal = document.getElementById('stats-date-calendar-modal');
        const statsDateCalendarMonthYear = document.getElementById('stats-date-calendar-month-year');
        const statsDateCalendarGridYear = document.getElementById('stats-date-calendar-grid-year');
        const statsDatePrevYearBtn = document.getElementById('stats-date-prev-year-btn');
        const statsDateNextYearBtn = document.getElementById('stats-date-next-year-btn');
        const closeStatsDateCalendarModal = document.getElementById('close-stats-date-calendar-modal');
        const cancelStatsDateCalendar = document.getElementById('cancel-stats-date-calendar');
        const confirmStatsDateCalendar = document.getElementById('confirm-stats-date-calendar');
        const statsFilterBtn = document.getElementById('stats-filter-btn');
        
        // 详情页面元素
        const backBtn = document.getElementById('back-btn');
        const detailTimer = document.getElementById('detail-timer');
        const detailStartBtn = document.getElementById('detail-start-btn');
        const detailStopBtn = document.getElementById('detail-stop-btn');

        // 全年日历元素
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const calendarGridYear = document.getElementById('calendar-grid-year');
        const prevYearBtn = document.getElementById('prev-year-btn');
        const nextYearBtn = document.getElementById('next-year-btn');
        const confirmFullCalendar = document.getElementById('confirm-full-calendar');

// 添加窗口大小变化监听
window.addEventListener('resize', function() {
    // 重新调整所有图表大小
    if (window.completionChart) window.completionChart.resize();
    if (window.timeComparisonChart) window.timeComparisonChart.resize();
    if (window.categoryPieChart) window.categoryPieChart.resize();
    if (window.planVsActualChart) window.planVsActualChart.resize();
});

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 恢复正在运行的计时器
            restoreRunningTimers();
            
            renderCalendar();
            renderPlans();
            setupEventListeners();
            updateStats();
            updateWeekTitle();

             // 初始化计划用时筛选日期显示
        planActualDateDisplay.textContent = formatDateForDisplay(selectedPlanActualDate);
        
        // 初始化统计图表日期显示
        document.getElementById('start-date-display').textContent = formatDateForDisplay(selectedStatsStartDate);
        document.getElementById('end-date-display').textContent = formatDateForDisplay(selectedStatsEndDate);
    });

          // 恢复正在运行的计时器
    function restoreRunningTimers() {
        plans.forEach(plan => {
            if (plan.running && plan.startTime) {
                // 计算从开始到现在的时间差
                const elapsed = Date.now() - plan.startTime;
                
                // 如果计划有总持续时间，将其加上
                if (plan.totalDuration) {
                    plan.totalDuration += elapsed;
                } else {
                    plan.totalDuration = elapsed;
                }
                
                // 重置开始时间为当前时间，这样计时器会继续从正确的位置开始
                plan.startTime = Date.now();
                
                // 开始新的计时器
                startTimerInterval(plan.id);
            }
        });
    }

        // 设置事件监听器
        function setupEventListeners() {
            // 打开添加计划模态框
            addPlanBtn.addEventListener('click', function() {
                addPlanModal.style.display = 'flex';
            });

            // 打开批量添加模态框
            batchAddBtn.addEventListener('click', function() {
                batchAddModal.style.display = 'flex';
            });

            // 数据管理按钮
            backupBtn.addEventListener('click', function() {
                backupData();
            });

            importBtn.addEventListener('click', function() {
                importModal.style.display = 'flex';
            });

            clearBtn.addEventListener('click', function() {
                clearConfirmModal.style.display = 'flex';
            });

            // 周导航 - 一周一周滚动
            prevWeekBtn.addEventListener('click', function() {
                currentWeekOffset--;
                renderCalendar();
                updateWeekTitle();
            });

            nextWeekBtn.addEventListener('click', function() {
                currentWeekOffset++;
                renderCalendar();
                updateWeekTitle();
            });

            // 今天按钮点击事件 - 跳转到今天
            todayBtn.addEventListener('click', function() {
                currentWeekOffset = 0;
                selectedDate = new Date();
                renderCalendar();
                updateWeekTitle();
                renderPlans();
                updateStats();
            });

            // 打开全年日历
            fullCalendarBtn.addEventListener('click', function() {
                selectedCalendarDate = new Date(selectedDate);
                renderFullCalendar(selectedCalendarDate);
                fullCalendarModal.style.display = 'flex';
            });

            // 全年日历导航
            prevYearBtn.addEventListener('click', function() {
                selectedCalendarDate.setMonth(selectedCalendarDate.getMonth() - 1);
                renderFullCalendar(selectedCalendarDate);
            });

            nextYearBtn.addEventListener('click', function() {
                selectedCalendarDate.setMonth(selectedCalendarDate.getMonth() + 1);
                renderFullCalendar(selectedCalendarDate);
            });

            // 确认选择日期
            confirmFullCalendar.addEventListener('click', function() {
                if (selectedCalendarDate) {
                    selectedDate = new Date(selectedCalendarDate);
                    
                    // 计算选中日期所在的周偏移
                    const today = new Date();
                    const startOfThisWeek = getStartOfWeek(today);
                    const startOfSelectedWeek = getStartOfWeek(selectedDate);
                    const diffTime = startOfSelectedWeek - startOfThisWeek;
                    const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000));
                    
                    currentWeekOffset = diffWeeks;
                    renderCalendar();
                    updateWeekTitle();
                    renderPlans();
                    updateStats();
                    
                    fullCalendarModal.style.display = 'none';
                }
            });

            // 详情页面返回按钮
            backBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                currentDetailPlanId = null;
            });

           // 详情页面计时器控制
        detailStartBtn.addEventListener('click', function() {
            // 如果已经有计时器在运行，且不是当前详情页面显示的计划
            if (currentRunningTimer && currentRunningTimer !== currentDetailPlanId) {
                alert('请先完成当前正在进行的计划，再开始新的计划');
                return;
            }
            
            if (currentDetailPlanId) {
                toggleTimer(currentDetailPlanId);
            }
        });

        detailStopBtn.addEventListener('click', function() {
            if (currentDetailPlanId) {
                stopTimer(currentDetailPlanId);
            }
        });

        document.getElementById('detail-cancel-btn').addEventListener('click', function() {
            if (currentDetailPlanId) {
                cancelPlan(currentDetailPlanId);
            }
        });

            // 详情页面编辑和删除按钮
            document.getElementById('edit-btn').addEventListener('click', function() {
                if (currentDetailPlanId) {
                    openEditModal(currentDetailPlanId);
                }
            });

            document.getElementById('delete-btn').addEventListener('click', function() {
                if (confirm('确定要删除这个计划吗？')) {
                    if (currentDetailPlanId) {
                        const planIndex = plans.findIndex(p => p.id == currentDetailPlanId);
                        if (planIndex !== -1) {
                            // 停止计时器
                            if (timers[currentDetailPlanId]) {
                                clearInterval(timers[currentDetailPlanId]);
                                delete timers[currentDetailPlanId];
                            }
                            
                            plans.splice(planIndex, 1);
                            localStorage.setItem('studyPlans', JSON.stringify(plans));
                            renderPlans();
                            updateStats();
                            detailModal.style.display = 'none';
                            currentDetailPlanId = null;
                        }
                    }
                }
            });

            // 关闭模态框
            document.getElementById('close-add-plan-modal').addEventListener('click', function() {
                addPlanModal.style.display = 'none';
            });

            document.getElementById('close-batch-add-modal').addEventListener('click', function() {
                batchAddModal.style.display = 'none';
            });

            document.getElementById('close-backup-modal').addEventListener('click', function() {
                backupModal.style.display = 'none';
            });

            document.getElementById('close-import-modal').addEventListener('click', function() {
                importModal.style.display = 'none';
            });

            document.getElementById('close-clear-modal').addEventListener('click', function() {
                clearConfirmModal.style.display = 'none';
            });

            document.getElementById('close-edit-plan-modal').addEventListener('click', function() {
                editPlanModal.style.display = 'none';
            });

            document.getElementById('close-full-calendar-modal').addEventListener('click', function() {
                fullCalendarModal.style.display = 'none';
            });

            // 取消按钮
            document.getElementById('cancel-add-plan').addEventListener('click', function() {
                addPlanModal.style.display = 'none';
            });

            document.getElementById('cancel-batch-add').addEventListener('click', function() {
                batchAddModal.style.display = 'none';
            });

            document.getElementById('close-backup').addEventListener('click', function() {
                backupModal.style.display = 'none';
            });

            document.getElementById('cancel-import').addEventListener('click', function() {
                importModal.style.display = 'none';
            });

            document.getElementById('cancel-clear').addEventListener('click', function() {
                clearConfirmModal.style.display = 'none';
            });

            document.getElementById('cancel-edit-plan').addEventListener('click', function() {
                editPlanModal.style.display = 'none';
            });

            document.getElementById('cancel-full-calendar').addEventListener('click', function() {
                fullCalendarModal.style.display = 'none';
            });

            // 确认清空
            document.getElementById('confirm-clear').addEventListener('click', function() {
                clearAllPlans();
                clearConfirmModal.style.display = 'none';
            });

            // 表单提交
            document.getElementById('add-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePlan();
            });

            document.getElementById('batch-add-form').addEventListener('submit', function(e) {
                e.preventDefault();
                batchAddPlans();
            });

            document.getElementById('import-form').addEventListener('submit', function(e) {
                e.preventDefault();
                importData();
            });

            document.getElementById('edit-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEditedPlan();
            });

            // 下载备份
            document.getElementById('download-backup').addEventListener('click', function() {
                downloadBackup();
            });

            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === addPlanModal) {
                    addPlanModal.style.display = 'none';
                }
                if (event.target === batchAddModal) {
                    batchAddModal.style.display = 'none';
                }
                if (event.target === backupModal) {
                    backupModal.style.display = 'none';
                }
                if (event.target === importModal) {
                    importModal.style.display = 'none';
                }
                if (event.target === clearConfirmModal) {
                    clearConfirmModal.style.display = 'none';
                }
                if (event.target === editPlanModal) {
                    editPlanModal.style.display = 'none';
                }
                if (event.target === fullCalendarModal) {
                    fullCalendarModal.style.display = 'none';
                }
            });

            // 在这里添加统计图表相关的事件监听器
            statsChartCard.addEventListener('click', function() {
                openStatsDetailModal();
            });

           // 在统计详情页返回按钮添加事件
            statsBackBtn.addEventListener('click', function() {
                statsDetailModal.style.display = 'none';
            });

           // 筛选按钮事件
            document.querySelector('.filter-btn').addEventListener('click', function() {
                    // 这里可以添加日期选择器功能，暂时使用默认日期范围
                     const endDate = new Date();
                     const startDate = new Date();
                     startDate.setDate(startDate.getDate() - 14);
        
                    renderStatsCharts(startDate, endDate);
           });

           // 点击模态框外部关闭统计图表详情页
           window.addEventListener('click', function(event) {
               if (event.target === document.getElementById('stats-detail-modal')) {
                   document.getElementById('stats-detail-modal').style.display = 'none';
               }
           });

// 新增的事件监听器 - 计划用时筛选
        planActualDateInput.addEventListener('click', function() {
            selectedPlanActualCalendarDate = new Date(selectedPlanActualDate);
            renderPlanActualCalendar(selectedPlanActualCalendarDate);
            planActualCalendarModal.style.display = 'flex';
        });
        
        // 计划用时筛选日历导航
        planActualPrevYearBtn.addEventListener('click', function() {
            selectedPlanActualCalendarDate.setMonth(selectedPlanActualCalendarDate.getMonth() - 1);
            renderPlanActualCalendar(selectedPlanActualCalendarDate);
        });
        
        planActualNextYearBtn.addEventListener('click', function() {
            selectedPlanActualCalendarDate.setMonth(selectedPlanActualCalendarDate.getMonth() + 1);
            renderPlanActualCalendar(selectedPlanActualCalendarDate);
        });
        
        // 确认选择日期 - 计划用时筛选
        confirmPlanActualCalendar.addEventListener('click', function() {
            if (selectedPlanActualCalendarDate) {
                selectedPlanActualDate = new Date(selectedPlanActualCalendarDate);
                planActualDateDisplay.textContent = formatDateForDisplay(selectedPlanActualDate);
                planActualCalendarModal.style.display = 'none';
                
                // 重新渲染计划用时与实际用时对比图表
                const statsData = getStatsData(new Date(), new Date()); // 这里只需要日期，所以传入任意范围
                renderPlanVsActualChart(statsData);
            }
        });
                 
 // 计划用时筛选按钮
        planActualFilterBtn.addEventListener('click', function() {
            // 重新渲染计划用时与实际用时对比图表
            const statsData = getStatsData(new Date(), new Date()); // 这里只需要日期，所以传入任意范围
            renderPlanVsActualChart(statsData);
        });
     
        // 关闭计划用时筛选日历
        closePlanActualCalendarModal.addEventListener('click', function() {
            planActualCalendarModal.style.display = 'none';
        });
        
        cancelPlanActualCalendar.addEventListener('click', function() {
            planActualCalendarModal.style.display = 'none';
        });
        
        // 点击模态框外部关闭计划用时筛选日历
        window.addEventListener('click', function(event) {
            if (event.target === planActualCalendarModal) {
                planActualCalendarModal.style.display = 'none';
            }
        });
  
// 新增统计图表日期筛选事件监听
        document.getElementById('start-date').addEventListener('click', function() {
            currentStatsDateSelection = 'start';
            selectedStatsCalendarDate = new Date(selectedStatsStartDate);
            renderStatsDateCalendar(selectedStatsCalendarDate);
            statsDateCalendarModal.style.display = 'flex';
        });
        
        document.getElementById('end-date').addEventListener('click', function() {
            currentStatsDateSelection = 'end';
            selectedStatsCalendarDate = new Date(selectedStatsEndDate);
            renderStatsDateCalendar(selectedStatsCalendarDate);
            statsDateCalendarModal.style.display = 'flex';
        });
        
        // 统计图表日期筛选日历导航
        statsDatePrevYearBtn.addEventListener('click', function() {
            selectedStatsCalendarDate.setMonth(selectedStatsCalendarDate.getMonth() - 1);
            renderStatsDateCalendar(selectedStatsCalendarDate);
        });
        
        statsDateNextYearBtn.addEventListener('click', function() {
            selectedStatsCalendarDate.setMonth(selectedStatsCalendarDate.getMonth() + 1);
            renderStatsDateCalendar(selectedStatsCalendarDate);
        });
        
        // 确认选择日期 - 统计图表日期筛选
        confirmStatsDateCalendar.addEventListener('click', function() {
            if (selectedStatsCalendarDate) {
                if (currentStatsDateSelection === 'start') {
                    selectedStatsStartDate = new Date(selectedStatsCalendarDate);
                } else if (currentStatsDateSelection === 'end') {
                    selectedStatsEndDate = new Date(selectedStatsCalendarDate);
                }
                updateStatsDateDisplay();
                statsDateCalendarModal.style.display = 'none';
                
                // 重新渲染统计图表
                renderStatsCharts(selectedStatsStartDate, selectedStatsEndDate);
            }
        });
        
        // 关闭统计图表日期筛选日历
        closeStatsDateCalendarModal.addEventListener('click', function() {
            statsDateCalendarModal.style.display = 'none';
        });
        
        cancelStatsDateCalendar.addEventListener('click', function() {
            statsDateCalendarModal.style.display = 'none';
        });
        
        // 点击模态框外部关闭统计图表日期筛选日历
        window.addEventListener('click', function(event) {
            if (event.target === statsDateCalendarModal) {
                statsDateCalendarModal.style.display = 'none';
            }
        });
              
// 统计图表筛选按钮事件
        statsFilterBtn.addEventListener('click', function() {
            renderStatsCharts(selectedStatsStartDate, selectedStatsEndDate);
        });

        // 点击模态框外部关闭统计图表详情页
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('stats-detail-modal')) {
                document.getElementById('stats-detail-modal').style.display = 'none';
            }
        });
    }

    // 渲染统计图表日期筛选日历
    function renderStatsDateCalendar(date) {
        statsDateCalendarGridYear.innerHTML = '';
        
        const year = date.getFullYear();
        const month = date.getMonth();
        
        // 更新标题
        statsDateCalendarMonthYear.textContent = `${year}年${month + 1}月`;
        
        // 添加星期头部
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        for (let i = 0; i < 7; i++) {
            const weekdayElement = document.createElement('div');
            weekdayElement.className = 'calendar-weekday';
            weekdayElement.textContent = weekdays[i];
            statsDateCalendarGridYear.appendChild(weekdayElement);
        }
        
        // 获取当月第一天是星期几
        const firstDay = new Date(year, month, 1);
        const firstDayWeekday = firstDay.getDay();
        
        // 获取当月天数
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // 填充空白
        for (let i = 0; i < firstDayWeekday; i++) {
            const emptyElement = document.createElement('div');
            emptyElement.className = 'calendar-day-year other-month';
            statsDateCalendarGridYear.appendChild(emptyElement);
        }
        
        // 填充日期
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day-year';
            dayElement.textContent = day;
            
            // 检查是否是今天 - 重置时间为午夜进行比较
            const todayMidnight = new Date();
            todayMidnight.setHours(0, 0, 0, 0);
            const currentDate = new Date(year, month, day);
            currentDate.setHours(0, 0, 0, 0);
            
            if (currentDate.getTime() === todayMidnight.getTime()) {
                dayElement.classList.add('today');
            }
            
            // 检查是否是选中的日期 - 重置时间为午夜进行比较
            if (selectedStatsCalendarDate) {
                const selectedStatsCalendarDateMidnight = new Date(selectedStatsCalendarDate);
                selectedStatsCalendarDateMidnight.setHours(0, 0, 0, 0);
                
                if (currentDate.getTime() === selectedStatsCalendarDateMidnight.getTime()) {
                    dayElement.classList.add('selected');
                }
            }
            
            // 添加点击事件
            dayElement.addEventListener('click', function() {
                selectedStatsCalendarDate = new Date(year, month, day);
                renderStatsDateCalendar(date);
            });
            
            statsDateCalendarGridYear.appendChild(dayElement);
        }
    }

    // 更新统计图表日期显示
    function updateStatsDateDisplay() {
        document.getElementById('start-date-display').textContent = formatDateForDisplay(selectedStatsStartDate);
        document.getElementById('end-date-display').textContent = formatDateForDisplay(selectedStatsEndDate);
    }

    // 打开统计图表详情页
    function openStatsDetailModal() {
        // 设置默认日期范围（最近15天）
        selectedStatsEndDate = new Date();
        selectedStatsStartDate = new Date();
        selectedStatsStartDate.setDate(selectedStatsStartDate.getDate() - 14);
        
        // 更新日期显示
        updateStatsDateDisplay();
        
        // 渲染所有图表
        renderStatsCharts(selectedStatsStartDate, selectedStatsEndDate);
        
        // 显示详情页
        statsDetailModal.style.display = 'block';
    }

    // 渲染统计图表
    function renderStatsCharts(startDate, endDate) {
        // 获取日期范围内的数据
        const statsData = getStatsData(startDate, endDate);

        // 渲染每日计划完成情况
         window.completionChart = renderCompletionChart(statsData);

        // 渲染时间对比图表
        window.timeComparisonChart = renderTimeComparisonChart(statsData);

        // 渲染分类用时占比
         window.categoryPieChart = renderCategoryPieChart(statsData);

        // 渲染计划用时与实际时间对比
         window.planVsActualChart = renderPlanVsActualChart(statsData);
    }

    // 获取统计数据
    function getStatsData(startDate, endDate) {
    const result = {
        dates: [],
        completionData: [],
        timeData: {
            study: [],
            sports: [],
            relax: []
        },
        categoryData: {},
        planComparisonData: []
    };

    // 生成日期范围
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        result.dates.push(formatDateForDisplay(currentDate));

        // 获取该日期的计划
        const datePlans = plans.filter(plan => {
            const planDate = new Date(plan.createdAt).toISOString().split('T')[0];
            return planDate === dateStr;
        });

        // 计算完成率
        const completedPlans = datePlans.filter(plan => plan.completed);
        const completionRate = datePlans.length > 0 ? 
            Math.round((completedPlans.length / datePlans.length) * 100) : 0;

        result.completionData.push({
            total: datePlans.length,
            completed: completedPlans.length,
            rate: completionRate
        });

        // 计算各类时间
        let studyTime = 0;
        let sportsTime = 0;
        let relaxTime = 0;

        completedPlans.forEach(plan => {
            const durationHours = (plan.totalDuration || 0) / (1000 * 60 * 60); // 转换为小时

            if (plan.subject === 'sports') {
                sportsTime += durationHours;
            } else if (plan.subject === 'relax') {
                relaxTime += durationHours;
            } else {
                studyTime += durationHours;
            }

            // 统计分类数据
            const subjectName = getSubjectText(plan.subject);
            if (!result.categoryData[subjectName]) {
                result.categoryData[subjectName] = 0;
            }
            result.categoryData[subjectName] += durationHours;
        });

        result.timeData.study.push(studyTime);
        result.timeData.sports.push(sportsTime);
        result.timeData.relax.push(relaxTime);

        // 为最后一天生成计划对比数据 - 使用新的解析函数
        if (currentDate.getTime() === endDate.getTime()) {
            datePlans.forEach(plan => {
                const plannedDuration = parseDurationToMinutes(plan.plannedDuration || '30min');
                const actualDuration = plan.completed ? (plan.totalDuration || 0) / (1000 * 60) : 0; // 分钟

                result.planComparisonData.push({
                    name: plan.name,
                    planned: plannedDuration,
                    actual: actualDuration
                });
            });
        }

        currentDate.setDate(currentDate.getDate() + 1);
    }

    return result;
}

    // 新增一个专门的函数来解析持续时间到分钟
function parseDurationToMinutes(durationStr) {
    if (!durationStr) return 30; // 默认30分钟
    
    // 处理 "60min" 格式
    const minMatch = durationStr.match(/(\d+)\s*min/);
    if (minMatch) {
        return parseInt(minMatch[1]);
    }
    
    // 处理 "1h" 或 "1小时" 格式
    const hourMatch = durationStr.match(/(\d+)\s*h/);
    if (hourMatch) {
        return parseInt(hourMatch[1]) * 60;
    }
    
    // 处理 "1h30min" 格式
    const combinedMatch = durationStr.match(/(\d+)\s*h\s*(\d+)\s*min/);
    if (combinedMatch) {
        return parseInt(combinedMatch[1]) * 60 + parseInt(combinedMatch[2]);
    }
    
    // 处理纯数字，假设为分钟
    const numberMatch = durationStr.match(/(\d+)/);
    if (numberMatch) {
        return parseInt(numberMatch[1]);
    }
    
    return 30; // 默认30分钟
}

    // 渲染每日计划完成情况图表
    function renderCompletionChart(statsData) {
        const chart = echarts.init(document.getElementById('completion-chart'));
        
        const option = {
            title: {
                text: '每日计划完成情况',
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
               left: 'center',
               top: '0px'
            },
        grid: {
            top: '90px', // 图表区域顶部间距
            bottom: '60px', // 图表区域底部间距
            left: '30px', // 图表区域左侧间距
            right: '30px' // 图表区域右侧间距
        },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    const data = statsData.completionData[params[0].dataIndex];
                    return `${params[0].name}<br/>
                            计划数量: ${data.total}<br/>
                            完成数量: ${data.completed}<br/>
                            完成率: ${data.rate}%`;
                }
            },
            legend: {
                data: ['计划数量', '完成数量'],
                top: '10%',
                textStyle: {
                    fontSize: 15,
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                type: 'category',
                data: statsData.dates,
                axisLabel: {
                    rotate: 0,
                formatter: function(value) {
                    // 只显示月日格式，例如 "10/01"
                    const parts = value.split('/');
                    if (parts.length >= 2) {
                        return `${parts[1]}/${parts[2]}`; // 月/日
                    }
                    return value;
                }
                }
            },
            yAxis: {
                type: 'value',
                name: '数量'
            },
            series: [
                {
                    name: '计划数量',
                    type: 'bar',
                    data: statsData.completionData.map(d => d.total),
                    itemStyle: {
                        color: '#4b6bbe'
                    }
                },
                {
                    name: '完成数量',
                    type: 'bar',
                    data: statsData.completionData.map(d => d.completed),
                    itemStyle: {
                        color: '#28a745'
                    }
                }
            ]
        };
        
        chart.setOption(option);

setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
    }

    // 渲染时间对比图表
    function renderTimeComparisonChart(statsData) {
        const chart = echarts.init(document.getElementById('time-comparison-chart'));
        
        const option = {
            title: {
                text: '每日学习时间 VS 运动时间 VS 娱乐时间',
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
                left: 'center'
            },
grid: {
            top: '90px', // 图表区域顶部间距
            bottom: '60px', // 图表区域底部间距
            left: '30px', // 图表区域左侧间距
            right: '30px' // 图表区域右侧间距
        },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['学习时间(小时)', '运动时间(小时)', '娱乐时间(小时)'],
                top: '10%',
                textStyle: {
                    fontSize: 15,
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                type: 'category',
                data: statsData.dates,
                axisLabel: {
                    rotate: 0,
                formatter: function(value) {
                    // 只显示月日格式，例如 "10/01"
                    const parts = value.split('/');
                    if (parts.length >= 2) {
                        return `${parts[1]}/${parts[2]}`; // 月/日
                    }
                    return value;
                }
                }
            },
            yAxis: {
                type: 'value',
                name: '小时',
axisLabel: {
    formatter: function(value) {
        // 如果是整数，直接显示；如果是小数，保留一位小数
        if (Number.isInteger(value)) {
            return value.toString();
        } else {
            return value.toFixed(1);
        }
    }
}
            },
            series: [
                {
                    name: '学习时间(小时)',
                    type: 'bar',
                    data: statsData.timeData.study,
                    itemStyle: {
                        color: '#4b6bbe'
                    }
                },
                {
                    name: '运动时间(小时)',
                    type: 'bar',
                    data: statsData.timeData.sports,
                    itemStyle: {
                        color: '#28a745'
                    }
                },
                {
                    name: '娱乐时间(小时)',
                    type: 'bar',
                    data: statsData.timeData.relax,
                    itemStyle: {
                        color: '#e1443b'
                    }
                }
            ]
        };
        
        chart.setOption(option);

setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
    }

    // 渲染分类饼图
    function renderCategoryPieChart(statsData) {
        const chart = echarts.init(document.getElementById('category-pie-chart'));
        
        const subjectColors = {
            '英语': '#c690ce',
            '语文': '#99ddae', 
            '数学': '#f79d82',
            '运动': '#6ac9e0',
            '放松': '#ff5252',
            '技能': '#debbb3',
            '其他': '#5f7ebe'
        };
        
        const pieData = Object.entries(statsData.categoryData)
            .filter(([_, value]) => value > 0)
            .map(([name, value]) => ({
                name,
                value: parseFloat(value.toFixed(2)),
                itemStyle: {
                    color: subjectColors[name] || '#5f7ebe'
                }
            }));
        
        const option = {
            title: {
                text: '分类总用时占比',
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c}小时 ({d}%)'
            },
            legend: {
                type: 'scroll',
                orient: 'vertical',
                right: 50,
                top: 'middle',
                textStyle: {
                    fontSize: 15
                }
            },
            series: [
                {
                    name: '用时占比',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    data: pieData,
                   label: {
                    show: true,
                    position: 'inside', // 将标签显示在饼图内部
                    formatter: '{d}%', // 只显示百分比
                    fontSize: 13,
                    fontWeight: 'bold',
                    color: '#fff', // 白色文字，确保在深色背景上可见
                    textShadow: '0 1px 2px rgba(0,0,0,0.5)' // 添加文字阴影增强可读性
                },
                // 移除标签引导线，因为现在标签在内部
                labelLine: {
                    show: false
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 16,
                        fontWeight: 'bold'
                    },
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
        
        chart.setOption(option);

setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
    }

    // 渲染计划用时与实际时间对比
   function renderPlanVsActualChart(statsData) {
    const chart = echarts.init(document.getElementById('plan-vs-actual-chart'));
    
    // 获取选中日期的已完成计划，保持原顺序
    const selectedDateStr = selectedPlanActualDate.toISOString().split('T')[0];
    const datePlans = plans.filter(plan => {
        const planDate = new Date(plan.createdAt).toISOString().split('T')[0];
        return planDate === selectedDateStr && plan.completed;
    });
    
    // 直接使用过滤后的计划数组，保持原有顺序
    const planComparisonData = datePlans.map(plan => {
        // 修复计划用时解析 - 确保正确解析分钟数
        const plannedDuration = parseDurationToMinutes(plan.plannedDuration || '30min');
        
        // 修复实际用时计算 - 将毫秒转换为分钟
        const actualDuration = plan.completed ? (plan.totalDuration || 0) / (1000 * 60) : 0; // 毫秒转分钟
        
        return {
            name: plan.name,
            planned: plannedDuration,
            actual: actualDuration
        };
    });

    // 如果当天没有已完成的计划，显示提示信息
    if (planComparisonData.length === 0) {
        const option = {
            title: {
                text: `计划用时与实际时间对比 - ${formatDateForDisplay(selectedPlanActualDate)}`,
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
                left: 'center'
            },
            graphic: {
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: '当天没有已完成的计划',
                    fontSize: 16,
                    fill: '#999'
                }
            }
        };
        
        chart.setOption(option);
        setTimeout(() => { chart.resize(); }, 0);
        return chart;
    }

    const option = {
        title: {
            text: `计划用时与实际时间对比 - ${formatDateForDisplay(selectedPlanActualDate)}`,
            textStyle: {
                color: '#4b6bbe',
                fontSize: 18,
                fontWeight: 'bold'
            },
            left: 'center'
        },
        grid: {
            top: '90px',
            bottom: '60px',
            left: '30px', 
            right: '30px'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                const plannedData = params[0];
                const actualData = params[1];
                return `
                    ${plannedData.name}<br/>
                    计划时间: ${plannedData.value}分钟<br/>
                    实际时间: ${actualData.value}分钟<br/>
                    差值: ${(actualData.value - plannedData.value).toFixed(1)}分钟
                `;
            }
        },
        legend: {
            data: ['计划时间', '实际时间'],
            top: '10%',
            textStyle: {
                fontSize: 15,
                fontWeight: 'bold'
            }
        },
        xAxis: {
            type: 'category',
            data: planComparisonData.map(d => d.name),
            axisLabel: {
                rotate: 0,
                interval: 0, // 显示所有标签
                formatter: function(value) {
                    // 如果名称太长，截断显示
                    return value.length > 8 ? value.substring(0, 8) + '...' : value;
                }
            }
        },
        yAxis: {
            type: 'value',
            name: '分钟'
        },
        series: [
            {
                name: '计划时间',
                type: 'bar',
                data: planComparisonData.map(d => d.planned),
                itemStyle: {
                    color: '#4b6bbe'
                }
            },
            {
                name: '实际时间',
                type: 'bar',
                data: planComparisonData.map(d => d.actual),
                itemStyle: {
                    color: '#28a745'
                }
            }
        ]
    };
    
    chart.setOption(option);

    setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
}

    // 渲染计划用时筛选日历
    function renderPlanActualCalendar(date) {
        planActualCalendarGridYear.innerHTML = '';
        
        const year = date.getFullYear();
        const month = date.getMonth();
        
        // 更新标题
        planActualCalendarMonthYear.textContent = `${year}年${month + 1}月`;
        
        // 添加星期头部
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        for (let i = 0; i < 7; i++) {
            const weekdayElement = document.createElement('div');
            weekdayElement.className = 'calendar-weekday';
            weekdayElement.textContent = weekdays[i];
            planActualCalendarGridYear.appendChild(weekdayElement);
        }
        
        // 获取当月第一天是星期几
        const firstDay = new Date(year, month, 1);
        const firstDayWeekday = firstDay.getDay();
        
        // 获取当月天数
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // 填充空白
        for (let i = 0; i < firstDayWeekday; i++) {
            const emptyElement = document.createElement('div');
            emptyElement.className = 'calendar-day-year other-month';
            planActualCalendarGridYear.appendChild(emptyElement);
        }
        
        // 填充日期
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day-year';
            dayElement.textContent = day;
            
            // 检查是否是今天 - 重置时间为午夜进行比较
            const todayMidnight = new Date();
            todayMidnight.setHours(0, 0, 0, 0);
            const currentDate = new Date(year, month, day);
            currentDate.setHours(0, 0, 0, 0);
            
            if (currentDate.getTime() === todayMidnight.getTime()) {
                dayElement.classList.add('today');
            }
            
            // 检查是否是选中的日期 - 重置时间为午夜进行比较
            if (selectedPlanActualCalendarDate) {
                const selectedPlanActualCalendarDateMidnight = new Date(selectedPlanActualCalendarDate);
                selectedPlanActualCalendarDateMidnight.setHours(0, 0, 0, 0);
                
                if (currentDate.getTime() === selectedPlanActualCalendarDateMidnight.getTime()) {
                    dayElement.classList.add('selected');
                }
            }
            
            // 添加点击事件
            dayElement.addEventListener('click', function() {
                selectedPlanActualCalendarDate = new Date(year, month, day);
                renderPlanActualCalendar(date);
            });
            
            planActualCalendarGridYear.appendChild(dayElement);
        }
    }

        // 渲染学习计划列表
        function renderPlans() {
            planList.innerHTML = '';
            
            // 获取当前选中的日期
            const targetDate = new Date(selectedDate);
            targetDate.setHours(0, 0, 0, 0);
            const targetDateStr = targetDate.toISOString().split('T')[0];
            
            // 过滤出选中日期的计划
            const selectedDatePlans = plans.filter(plan => {
                const planDate = new Date(plan.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = planDate.toISOString().split('T')[0];
                return planDateStr === targetDateStr;
            });
            
            if (selectedDatePlans.length === 0) {
                planList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <i class="fas fa-book-open" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h3>暂无学习计划</h3>
                        <p>点击"添加计划"开始规划你的学习</p>
                    </div>
                `;
                return;
            }
            
            selectedDatePlans.forEach(plan => {
                const subjectNames = {
                    'english': '英语',
                    'chinese': '语文',
                    'math': '数学',
                    'sports': '运动',
                    'relax': '放松',
                    'skill': '技能',
                    'other': '其他'
                };
                
                const repeatNames = {
                    'once': '仅当天',
                    'daily': '每天',
                    'weekdays': '周一至周五',
                    'weekly': '每周的这天'
                };
                
                const planItem = document.createElement('div');
                planItem.className = `plan-item ${plan.completed ? 'completed' : ''} ${plan.running ? 'running' : ''}`;
                planItem.dataset.id = plan.id;

                if (currentRunningTimer && currentRunningTimer != plan.id) {
                    planItem.classList.add('disabled');
                }
                
                const iconHtml = plan.icon ? `<i class="${plan.icon}"></i>` : '';
                
                 // 计算当前持续时间
                const currentDuration = calculateCurrentDuration(plan);
                
                planItem.innerHTML = `
                    <div class="plan-subject ${plan.subject}">${subjectNames[plan.subject]}</div>
                    <div class="plan-content">
                        <div class="plan-header-row">
                            <div class="plan-name">${iconHtml} ${plan.name}</div>
                            <div class="plan-repeat">${repeatNames[plan.repeat]}</div>
                            ${plan.actualStartTime ? `<div class="plan-actual-time">实际时间: ${plan.actualStartTime}-${plan.actualEndTime || '进行中'}</div>` : ''}
                            <span class="duration-label">计划用时：</span>
                            <input type="text" class="planned-duration" value="${plan.plannedDuration || '30min'}" data-id="${plan.id}">
                        </div>
                        <textarea class="plan-desc">内容：${plan.description}</textarea>
                        <div class="detail-jump-area">
                            <i class="fas fa-external-link-alt"></i> 点击查看详情
                        </div>
                    </div>
                    <div class="plan-status">
                        <div class="timer-display ${plan.completed ? 'completed' : (plan.running ? 'timing' : (plan.canceled ? 'canceled' : ''))}">
                            ${formatDuration(currentDuration)}
                        </div>
                        <div class="timer-controls">
                            ${plan.completed ? 
                                `<div class="completed-indicator">
                                    <div class="completed-circle">✓</div>
                                    <span>已完成</span>
                                </div>` : 
                                plan.canceled ?
                                `<div class="canceled-indicator">
                                    <div class="canceled-circle">×</div>
                                    <span>未完成</span>
                                </div>` :
                                `<button class="timer-btn ${plan.running ? 'pause' : 'start'} ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}">
                                    ${plan.running ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'}
                                </button>
                                <button class="timer-btn stop ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}"><i class="fas fa-stop"></i></button>
                                <button class="timer-btn cancel ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}"><i class="fas fa-times"></i></button>`
                            }
                        </div>
                    </div>
                `;
                planList.appendChild(planItem);
            });

           // 添加计时按钮事件监听
            document.querySelectorAll('.timer-btn.start, .timer-btn.pause').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果按钮被禁用，则不执行操作
                    if (this.classList.contains('disabled')) {
                        alert('请先完成当前正在进行的计划，再开始新的计划');
                        return;
                    }
                    const planId = this.getAttribute('data-id');
                    toggleTimer(planId);
                });
            });

            // 添加停止按钮事件监听
            document.querySelectorAll('.timer-btn.stop').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果按钮被禁用，则不执行操作
                    if (this.classList.contains('disabled')) {
                        alert('请先完成当前正在进行的计划，再开始新的计划');
                        return;
                    }
                    const planId = this.getAttribute('data-id');
                    stopTimer(planId);
                });
            });

// 在现有的计时按钮事件监听器后面添加取消按钮事件监听器
document.querySelectorAll('.timer-btn.cancel').forEach(btn => {
    btn.addEventListener('click', function() {
        // 如果按钮被禁用，则不执行操作
        if (this.classList.contains('disabled')) {
            alert('请先完成当前正在进行的计划，再开始新的计划');
            return;
        }
        const planId = this.getAttribute('data-id');
        cancelPlan(planId);
    });
});

             // 为详情跳转区域添加点击事件
            document.querySelectorAll('.detail-jump-area').forEach(area => {
                area.addEventListener('click', function() {
                    const planItem = this.closest('.plan-item');
                    const planId = planItem.dataset.id;
                    openDetailModal(planId);
                });
            });

             // 添加内容编辑事件监听
            document.querySelectorAll('.plan-desc').forEach(textarea => {
                textarea.addEventListener('change', function() {
                    const planItem = this.closest('.plan-item');
                    const planId = planItem.dataset.id;
                    const planIndex = plans.findIndex(p => p.id == planId);
                    
                    if (planIndex !== -1) {
                        let content = this.value;
                        if (content.startsWith('内容：')) {
                            content = content.substring(3);
                        }
                        plans[planIndex].description = content;
                        localStorage.setItem('studyPlans', JSON.stringify(plans));
                    }
                });
            });

           // 添加计划用时编辑事件监听
            document.querySelectorAll('.planned-duration').forEach(input => {
                input.addEventListener('change', function() {
                    const planId = this.getAttribute('data-id');
                    const planIndex = plans.findIndex(p => p.id == planId);
                    
                    if (planIndex !== -1) {
                        plans[planIndex].plannedDuration = this.value;
                        localStorage.setItem('studyPlans', JSON.stringify(plans));
                    }
                });
            });
        }

           // 计算计划的当前持续时间
    function calculateCurrentDuration(plan) {
        if (plan.running && plan.startTime) {
            // 如果计时器正在运行，计算从开始时间到当前时间的时间差 + 之前累计的时间
            return (Date.now() - plan.startTime) + (plan.totalDuration || 0);
        } else if (plan.completed && plan.totalDuration) {
            // 如果已完成，返回总持续时间
            return plan.totalDuration;
        } else {
            // 否则返回已累计的时间
            return plan.totalDuration || 0;
        }
    }

        // 开始计时器间隔
        function startTimerInterval(planId) {
            // 清除现有的计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
            }
            
            // 创建新的计时器
            timers[planId] = setInterval(() => {
                const planIndex = plans.findIndex(p => p.id == planId);
                if (planIndex === -1) return;
                
                const plan = plans[planIndex];
                const currentDuration = calculateCurrentDuration(plan);
                
                // 更新主页显示
                const planElement = document.querySelector(`.plan-item[data-id="${planId}"]`);
                if (planElement) {
                    const timerDisplay = planElement.querySelector('.timer-display');
                    if (timerDisplay) {
                        timerDisplay.textContent = formatDuration(currentDuration);
                        timerDisplay.className = 'timer-display timing';
                    }
                }
                
                // 更新详情页面显示
                if (currentDetailPlanId == planId) {
                    detailTimer.textContent = formatDuration(currentDuration);
                    detailTimer.className = 'detail-timer-display timing';
                }
            }, 1000);
        }

        // 打开详情页面
        function openDetailModal(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            currentDetailPlanId = planId;
            
            // 计算当前持续时间
            const currentDuration = calculateCurrentDuration(plan);
            
            // 填充详情页面数据
            const iconHtml = plan.icon ? `<i class="${plan.icon}"></i>` : '';
            document.getElementById('detail-plan-name').innerHTML = `${iconHtml} ${plan.name}<div class="repeat-badge" id="detail-repeat">重复频率：${getRepeatText(plan.repeat)}</div>`;
            document.getElementById('detail-timer').textContent = formatDuration(currentDuration);
            document.getElementById('detail-subject').textContent = getSubjectText(plan.subject);
            document.getElementById('detail-planned-duration').textContent = plan.plannedDuration || '30min';
            document.getElementById('detail-date').textContent = formatDate(new Date(plan.createdAt));
            document.getElementById('detail-actual-time').textContent = plan.actualStartTime ? 
                `${plan.actualStartTime} - ${plan.actualEndTime || '进行中'}` : '未开始';
            document.getElementById('detail-description').value = plan.description;
            
            // 设置计时器状态
            updateDetailTimerDisplay(plan);
            
            // 显示详情页面
            detailModal.style.display = 'block';
        }

        // 更新详情页面计时器显示
        function updateDetailTimerDisplay(plan) {
    if (plan.running) {
        // 运行时显示暂停图标
        detailStartBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
        detailStartBtn.className = 'detail-timer-btn pause';
        detailTimer.className = 'detail-timer-display timing';
    } else if (plan.completed) {
        // 完成时显示播放图标
        detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
        detailStartBtn.className = 'detail-timer-btn start';
        detailTimer.className = 'detail-timer-display completed';
    } else if (plan.canceled) {
        // 取消时显示播放图标
        detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
        detailStartBtn.className = 'detail-timer-btn start';
        detailTimer.className = 'detail-timer-display canceled'; 
    } else {
        // 未开始时显示播放图标
        detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
        detailStartBtn.className = 'detail-timer-btn start';
        detailTimer.className = 'detail-timer-display';
    }
    
    // 更新计时器显示
    const currentDuration = calculateCurrentDuration(plan);
    detailTimer.textContent = formatDuration(currentDuration);
}

        // 打开编辑模态框
        function openEditModal(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            currentEditPlanId = planId;
            
            // 填充编辑模态框数据
            document.getElementById('edit-plan-subject').value = plan.subject;
            document.getElementById('edit-plan-name').value = plan.name;
            document.getElementById('edit-planned-duration').value = plan.plannedDuration || '30min';
            document.getElementById('edit-plan-repeat').value = plan.repeat;
            document.getElementById('edit-plan-description').value = plan.description;
            
            // 隐藏详情页面，显示编辑模态框
            detailModal.style.display = 'none';
            editPlanModal.style.display = 'flex';
        }

        // 保存计划
        function savePlan() {
            const planSubject = document.getElementById('plan-subject').value;
            const planName = document.getElementById('plan-name').value;
            const planDescription = document.getElementById('plan-description').value;
            const plannedDuration = document.getElementById('planned-duration').value;
            const planRepeat = document.getElementById('plan-repeat').value;
            
            const newPlan = {
                id: plans.length > 0 ? Math.max(...plans.map(p => p.id)) + 1 : 1,
                subject: planSubject,
                name: planName,
                description: planDescription,
                plannedDuration: plannedDuration,
                repeat: planRepeat,
                completed: false,
                running: false,
                startTime: null,
                totalDuration: 0,
                createdAt: selectedDate.toISOString()
            };
            
            plans.push(newPlan);
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 重置表单并关闭模态框
            document.getElementById('add-plan-form').reset();
            addPlanModal.style.display = 'none';
            
            // 重新渲染
            renderPlans();
            updateStats();
        }

        // 批量添加计划函数 - 修改科目映射和计划名称识别逻辑
        function batchAddPlans() {
            const batchInput = document.getElementById('batch-input').value;
            const plannedDuration = document.getElementById('batch-planned-duration').value;
            const batchRepeat = document.getElementById('batch-repeat').value;
            
            if (!batchInput.trim()) {
                alert('请输入计划内容！');
                return;
            }
            
            const lines = batchInput.split('\n').map(line => line.trim()).filter(line => line);
            let currentSubject = '';
            let newPlans = [];
    
            // 定义运动项目列表
            const sportsItems = ['羽毛球', '游泳', '跑步', '跳绳', '篮球', '足球', '乒乓球', '网球', 
                                '排球', '健身', '瑜伽', '舞蹈', '武术', '滑板', '轮滑', '骑行'];
            
            // 定义技能项目列表
            const skillItems = ['书法', '竹笛', '钢琴', '吉他', '小提琴', '画画', '绘画', '编程', '手工'];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // 检查是否是科目行
                if (['语文', '数学', '英语', '运动', '放松', '技能', '美术', '地理', '体育', '音乐', '生物', '历史', '道法'].includes(line)) {
                    currentSubject = line;
                } 
                // 检查是否是任务行（以数字和点开头）
                else if (line.match(/^\d+\./)) {
                    if (!currentSubject) {
                        alert('请先指定科目！');
                        return;
                    }
                    
                    // 科目映射 - 将历史、道法、美术、地理、体育、音乐、生物映射到"other"
                    const subjectMap = {
                        '语文': 'chinese',
                        '数学': 'math',
                        '英语': 'english',
                        '运动': 'sports',
                        '放松': 'relax',
                        '技能': 'skill',
                        '历史': 'other',
                        '道法': 'other',
                        '美术': 'other',
                        '地理': 'other',
                        '体育': 'other',
                        '音乐': 'other',
                        '生物': 'other'
                    };
                    
                    const subject = subjectMap[currentSubject] || 'other';
                    
                    // 提取任务内容
                    const taskContent = line.substring(line.indexOf('.') + 1).trim();
                    
                    // 根据任务内容识别计划名称和图标
                    let planName = '练习';
                    let icon = 'fas fa-book';

                    // 特殊处理：运动科目 - 检查是否包含特定运动项目
                    if (subject === 'sports') {
                        let foundSport = false;
                        // 检查任务内容中是否包含运动项目
                        for (const sport of sportsItems) {
                            if (taskContent.includes(sport)) {
                                planName = sport;
                                icon = 'fas fa-running';
                                foundSport = true;
                                break;
                            }
                        }
                        // 如果没有找到特定运动项目，使用默认的运动图标
                        if (!foundSport) {
                            planName = '运动';
                            icon = 'fas fa-running';
                        }
                    }
                    
                    // 特殊处理：技能科目 - 检查是否包含特定技能项目
                    if (subject === 'skill') {
                        let foundSkill = false;
                        // 检查任务内容中是否包含技能项目
                        for (const skill of skillItems) {
                            if (taskContent.includes(skill)) {
                                planName = skill;
                                icon = 'fas fa-paint-brush';
                                foundSkill = true;
                                break;
                            }
                        }
                        // 如果没有找到特定技能项目，使用默认的技能图标
                        if (!foundSkill) {
                            planName = '技能';
                            icon = 'fas fa-paint-brush';
                        }
                    }
                    
                    // 特殊处理：放松科目
                    if (subject === 'relax') {
                        planName = '放松';
                        icon = 'fas fa-couch';
                        
                        // 根据内容识别具体的放松活动
                        if (taskContent.includes('游戏') || taskContent.includes('玩')) {
                            planName = '游戏';
                        } else if (taskContent.includes('电影') || taskContent.includes('电视')) {
                            planName = '观影';
                        } else if (taskContent.includes('音乐') || taskContent.includes('听歌')) {
                            planName = '音乐';
                        } else if (taskContent.includes('阅读') || taskContent.includes('看书')) {
                            planName = '阅读';
                        }
                    }
                    
                    // 特殊处理：历史、道法科目（映射到other）
                    if (currentSubject === '历史' || currentSubject === '道法') {
                        planName = currentSubject;
                        icon = 'fas fa-book';
                    }
                    
                    // 优化改错类任务识别逻辑
                    if ((taskContent.includes('订') && taskContent.includes('卷')) || 
                        (taskContent.includes('订') && taskContent.includes('练习')) ||
                        taskContent.includes('错题')) {
                        planName = '改错';
                        icon = 'fas fa-calculator';
                    }
                    // 预复习类任务：包含"笔记"或"预习"
                    else if (taskContent.includes('笔记') || taskContent.includes('预习')) {
                        planName = '预复习';
                        icon = 'fas fa-book';
                    }
                    // 练习类任务
                    else if (taskContent.includes('练习') || taskContent.includes('习题') || 
                        taskContent.includes('课时') || taskContent.includes('卷') || 
                        taskContent.includes('题目')) {
                        planName = '练习';
                        icon = 'fas fa-book';
                    }
                    // 背默抄类任务
                    else if (taskContent.includes('默') || taskContent.includes('背') || 
                             taskContent.includes('复习') || taskContent.includes('摘抄') || 
                             taskContent.includes('抄写') || taskContent.includes('抄')) {
                        planName = '背默抄';
                        icon = 'fas fa-pencil-alt';
                    }
                    // 写作类任务
                    else if (taskContent.includes('作文') || taskContent.includes('周记') || 
                             taskContent.includes('短文')) {
                        planName = '写作';
                        icon = 'fas fa-pencil-alt';
                    }
                    // 听读类任务
                    else if (taskContent.includes('读')) {
                        planName = '听读';
                        icon = 'fas fa-headphones';
                    }
                    // 打卡类任务
                    else if (taskContent.includes('打卡')) {
                        planName = '打卡';
                        icon = 'fas fa-pencil-alt';
                    }
                    
                    // 特殊处理：如果科目是美术、地理、体育、音乐、生物、历史、道法，则计划名称为科目名称
                    if (['美术', '地理', '体育', '音乐', '生物', '历史', '道法'].includes(currentSubject)) {
                        planName = currentSubject;
                    }
                    
                    const newPlan = {
                        id: plans.length + newPlans.length > 0 ? Math.max(...plans.map(p => p.id), ...newPlans.map(p => p.id)) + 1 : 1,
                        subject: subject,
                        name: planName,
                        description: taskContent,
                        plannedDuration: plannedDuration,
                        repeat: batchRepeat,
                        completed: false,
                        running: false,
                        startTime: null,
                        totalDuration: 0,
                        createdAt: selectedDate.toISOString(),
                        icon: icon
                    };
                    
                    newPlans.push(newPlan);
                }
            }
            
            // 将新计划添加到现有计划中
            plans = plans.concat(newPlans);
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 重置表单并关闭模态框
            document.getElementById('batch-add-form').reset();
            batchAddModal.style.display = 'none';
            
            // 重新渲染
            renderPlans();
            updateStats();
        }

        // 获取科目文本函数 - 添加技能科目
        function getSubjectText(subject) {
            const subjectMap = {
                'english': '英语',
                'chinese': '语文',
                'math': '数学',
                'sports': '运动',
                'relax': '放松',
                'skill': '技能',
                'other': '其他'
            };
            return subjectMap[subject] || '其他';
        }

        // 保存编辑后的计划
        function saveEditedPlan() {
            const planIndex = plans.findIndex(p => p.id == currentEditPlanId);
            
            if (planIndex === -1) return;
            
            const planSubject = document.getElementById('edit-plan-subject').value;
            const planName = document.getElementById('edit-plan-name').value;
            const planDescription = document.getElementById('edit-plan-description').value;
            const plannedDuration = document.getElementById('edit-planned-duration').value;
            const planRepeat = document.getElementById('edit-plan-repeat').value;
            
            plans[planIndex].subject = planSubject;
            plans[planIndex].name = planName;
            plans[planIndex].description = planDescription;
            plans[planIndex].plannedDuration = plannedDuration;
            plans[planIndex].repeat = planRepeat;
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 关闭编辑模态框
            editPlanModal.style.display = 'none';
            
            // 重新渲染
            renderPlans();
            
            // 如果详情页面正在显示，更新详情页面
            if (currentDetailPlanId === currentEditPlanId) {
                openDetailModal(currentDetailPlanId);
                detailModal.style.display = 'block';
            }
            
            currentEditPlanId = null;
        }

 // 全局变量，跟踪当前正在运行的计时器
        let currentRunningTimer = null;

           // 计时功能
   function toggleTimer(planId) {
    const planIndex = plans.findIndex(p => p.id == planId);
    if (planIndex === -1) return;
    
    const plan = plans[planIndex];
    
    // 如果已经有计时器在运行，且不是当前计划
            if (currentRunningTimer && currentRunningTimer !== planId) {
                // 不允许同时运行多个计时器
                alert('请先完成当前正在进行的计划，再开始新的计划');
                return;
            }
    
    if (plan.running) {
         // 如果正在运行，暂停计时
                plan.running = false;
                currentRunningTimer = null;
            
            // 更新总持续时间
            if (plan.startTime) {
                plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
                plan.startTime = null;
            }
            
            // 暂停计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
                delete timers[planId];
            }
        } else {
            // 开始计时
            plan.running = true;
currentRunningTimer = planId; 
            
            // 设置开始时间
            plan.startTime = Date.now();
            
            // 记录实际开始时间（只在第一次开始时记录）
            if (!plan.actualStartTime) {
                plan.actualStartTime = formatTime(new Date());
            }
            
            // 创建计时器
            startTimerInterval(planId);
        }
        
        // 保存到本地存储
        localStorage.setItem('studyPlans', JSON.stringify(plans));
        
        // 重新渲染
        renderPlans();
        updateStats();
        
        // 更新详情页面显示
        if (currentDetailPlanId == planId) {
            updateDetailTimerDisplay(plan);
        }
    }

           // 停止计时
    function stopTimer(planId) {
        const planIndex = plans.findIndex(p => p.id == planId);
        if (planIndex === -1) return;
        
        const plan = plans[planIndex];
        
        // 停止计时器
        if (timers[planId]) {
            clearInterval(timers[planId]);
            delete timers[planId];
        }
        
        // 更新总持续时间
        if (plan.running && plan.startTime) {
            plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
            plan.startTime = null;
        }
        
        // 标记为完成
        plan.running = false;
        plan.completed = true;
 currentRunningTimer = null;
        
        // 记录实际结束时间
        if (plan.actualStartTime && !plan.actualEndTime) {
            plan.actualEndTime = formatTime(new Date());
        }
        
        // 保存到本地存储
        localStorage.setItem('studyPlans', JSON.stringify(plans));
        
        // 重新渲染
        renderPlans();
        updateStats();
        
        // 更新详情页面显示
        if (currentDetailPlanId == planId) {
            updateDetailTimerDisplay(plan);
            document.getElementById('detail-actual-time').textContent = 
                `${plan.actualStartTime} - ${plan.actualEndTime}`;
        }
    }

           // 取消计时
    function cancelPlan(planId) {
        const planIndex = plans.findIndex(p => p.id == planId);
        if (planIndex === -1) return;
    
        const plan = plans[planIndex];
    
        // 停止计时器
        if (timers[planId]) {
            clearInterval(timers[planId]);
            delete timers[planId];
        }
    
        // 如果有正在运行的计时器，重置相关状态
        if (plan.running) {
            if (plan.startTime) {
                plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
                plan.startTime = null;
            }
            plan.running = false;
            currentRunningTimer = null;
        }
    
        // 标记为已取消
        plan.canceled = true;
        plan.completed = false;
    
        // 保存到本地存储
        localStorage.setItem('studyPlans', JSON.stringify(plans));
    
        // 重新渲染
        renderPlans();
        updateStats();
    
        // 更新详情页面显示
       if (currentDetailPlanId == planId) {
            updateDetailTimerDisplay(plan);
        }
    }
        // 备份数据
        function backupData() {
            const backupTime = new Date();
            document.getElementById('backup-time').textContent = backupTime.toLocaleString();
            backupModal.style.display = 'flex';
        }

        // 下载备份
        function downloadBackup() {
            const backupData = {
                plans: plans,
                checkins: checkins,
                honors: honors, // 新增：勋章数据
                wishes: wishes, // 新增：兑换清单数据
                availableStars: availableStars, // 新增：可用星星数量
                backupTime: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "学习计划备份_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            backupModal.style.display = 'none';
        }

        // 导入数据
        function importData() {
            const importDataText = document.getElementById('data-import').value;
            
            if (!importDataText.trim()) {
                alert('请输入备份数据！');
                return;
            }
            
            try {
                const importedData = JSON.parse(importDataText);
                
                if (importedData.plans && Array.isArray(importedData.plans)) {
                    plans = importedData.plans;
                    localStorage.setItem('studyPlans', JSON.stringify(plans));
                    
                    if (importedData.checkins && Array.isArray(importedData.checkins)) {
                        checkins = importedData.checkins;
                        localStorage.setItem('studyCheckins', JSON.stringify(checkins));
                    }

        // 新增：导入荣誉勋章墙数据
                    if (importedData.honors && Array.isArray(importedData.honors)) {
                        honors = importedData.honors;
                        localStorage.setItem('studyHonors', JSON.stringify(honors));
                    }
            
                    if (importedData.wishes && Array.isArray(importedData.wishes)) {
                        wishes = importedData.wishes;
                        localStorage.setItem('studyWishes', JSON.stringify(wishes));
                    }
            
                    if (importedData.availableStars !== undefined) {
                        availableStars = importedData.availableStars;
                        localStorage.setItem('availableStars', availableStars.toString());
                    }
                    
            // 重新渲染
            renderPlans();
            renderCalendar();
            updateStats();
            
            // 重新初始化荣誉勋章墙数据
            updateHonorsAndStars();
            
            importModal.style.display = 'none';
            alert('数据导入成功！');
        } else {
            alert('备份数据格式不正确！');
        }
    } catch (e) {
        alert('备份数据格式不正确！');
    }
}

        // 清空所有计划
        function clearAllPlans() {
            plans = [];
            checkins = [];
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            localStorage.setItem('studyCheckins', JSON.stringify(checkins));
            
            // 清除所有计时器
            for (const timerId in timers) {
                clearInterval(timers[timerId]);
            }
            timers = {};
            
            // 重新渲染
            renderPlans();
            renderCalendar();
            updateStats();
        }

        // 渲染日历
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            startOfWeek.setDate(startOfWeek.getDate() + (currentWeekOffset * 7));
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 检查是否是今天 - 重置时间为午夜进行比较
                const todayMidnight = new Date();
                todayMidnight.setHours(0, 0, 0, 0);
                const dayMidnight = new Date(day);
                dayMidnight.setHours(0, 0, 0, 0);
                
                // 检查是否是选中的日期 - 重置时间为午夜进行比较
                const selectedDateMidnight = new Date(selectedDate);
                selectedDateMidnight.setHours(0, 0, 0, 0);
                
                // 修复日期高亮逻辑
                if (dayMidnight.getTime() === todayMidnight.getTime() && dayMidnight.getTime() === selectedDateMidnight.getTime()) {
                    // 如果今天被选中，显示为橙色
                    dayElement.classList.add('today');
                } else if (dayMidnight.getTime() === todayMidnight.getTime()) {
                    // 如果是今天但未被选中，显示为橙色
                    dayElement.classList.add('today');
                } else if (dayMidnight.getTime() === selectedDateMidnight.getTime()) {
                    // 如果是选中的日期但不是今天，显示为蓝色
                    dayElement.classList.add('selected');
                }
                
                const dateStr = day.toISOString().split('T')[0];
                const checkin = checkins.find(c => c.date === dateStr);
                if (checkin && checkin.plans.length > 0) {
                    dayElement.classList.add('checked');
                }
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const month = day.getMonth() + 1;
                const date = day.getDate();
                const weekday = weekdays[day.getDay()];
                
                dayElement.innerHTML = `
                    <div class="weekday">周${weekday}</div>
                    <div class="date">${month}/${date}</div>
                `;
                
                // 添加点击事件
                dayElement.addEventListener('click', function() {
                    selectedDate = new Date(day);
                    renderCalendar();
                    renderPlans();
                    updateStats();
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // 渲染全年日历
        function renderFullCalendar(date) {
            calendarGridYear.innerHTML = '';
            
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // 更新标题
            calendarMonthYear.textContent = `${year}年${month + 1}月`;
            
            // 添加星期头部
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            for (let i = 0; i < 7; i++) {
                const weekdayElement = document.createElement('div');
                weekdayElement.className = 'calendar-weekday';
                weekdayElement.textContent = weekdays[i];
                calendarGridYear.appendChild(weekdayElement);
            }
            
            // 获取当月第一天是星期几
            const firstDay = new Date(year, month, 1);
            const firstDayWeekday = firstDay.getDay();
            
            // 获取当月天数
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // 填充空白
            for (let i = 0; i < firstDayWeekday; i++) {
                const emptyElement = document.createElement('div');
                emptyElement.className = 'calendar-day-year other-month';
                calendarGridYear.appendChild(emptyElement);
            }
            
            // 填充日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-year';
                dayElement.textContent = day;
                
                // 检查是否是今天 - 重置时间为午夜进行比较
                const todayMidnight = new Date();
                todayMidnight.setHours(0, 0, 0, 0);
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                
                if (currentDate.getTime() === todayMidnight.getTime()) {
                    dayElement.classList.add('today');
                }
                
                // 检查是否是选中的日期 - 重置时间为午夜进行比较
                if (selectedCalendarDate) {
                    const selectedCalendarDateMidnight = new Date(selectedCalendarDate);
                    selectedCalendarDateMidnight.setHours(0, 0, 0, 0);
                    
                    if (currentDate.getTime() === selectedCalendarDateMidnight.getTime()) {
                        dayElement.classList.add('selected');
                    }
                }
                
                // 添加点击事件
                dayElement.addEventListener('click', function() {
                    selectedCalendarDate = new Date(year, month, day);
                    renderFullCalendar(date);
                });
                
                calendarGridYear.appendChild(dayElement);
            }
        }

        // 获取一周的开始日期（周一）
        function getStartOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const startOfWeek = new Date(date);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        // 更新周标题
        function updateWeekTitle() {
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            startOfWeek.setDate(startOfWeek.getDate() + (currentWeekOffset * 7));
            
            const year = startOfWeek.getFullYear();
            const month = startOfWeek.getMonth() + 1;
            
            const firstDayOfYear = new Date(year, 0, 1);
            const days = Math.floor((startOfWeek - firstDayOfYear) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + firstDayOfYear.getDay() + 1) / 7);
            
            weekTitle.textContent = `${year}年${month}月第${weekNumber}周`;
        }

                // 更新统计信息
        function updateStats() {
            // 获取选中日期的字符串
            const selectedDateMidnight = new Date(selectedDate);
            selectedDateMidnight.setHours(0, 0, 0, 0);
            const selectedDateStr = selectedDateMidnight.toISOString().split('T')[0];
            
            // 获取今天的日期字符串（用于连续打卡天数计算）
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // 计算连续打卡天数（仍然基于今天）
            const sortedDates = checkins.map(c => c.date).sort();
            let currentStreak = 0;
            
            if (sortedDates.includes(todayStr)) {
                currentStreak = 1;
                let currentDate = new Date(today);
                
                for (let i = 1; i <= 30; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const prevDate = currentDate.toISOString().split('T')[0];
                    
                    if (sortedDates.includes(prevDate)) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            document.getElementById('streak-days').textContent = currentStreak;
            
            // 计算累计完成计划数（所有时间）
            const completedPlans = plans.filter(p => p.completed).length;
            document.getElementById('total-plans').textContent = completedPlans;
            
            // 计算选中日期的学习时间和运动时间
            let selectedDateStudyTime = 0;
            let selectedDateSportsTime = 0;
            
            plans.forEach(plan => {
                // 检查计划是否是选中日期完成的
                const planDate = new Date(plan.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = planDate.toISOString().split('T')[0];
                
                if (planDateStr === selectedDateStr && plan.completed && plan.totalDuration) {
                    const durationHours = plan.totalDuration / (1000 * 60 * 60); // 转换为小时
                    
                    if (plan.subject === 'sports') {
                        selectedDateSportsTime += durationHours;
                    } else {
                        selectedDateStudyTime += durationHours;
                    }
                }
            });
            
            document.getElementById('today-study-time').textContent = selectedDateStudyTime.toFixed(1) + 'h';
            document.getElementById('today-sports-time').textContent = selectedDateSportsTime.toFixed(1) + 'h';
            
            // 计算选中日期的任务完成情况
            const selectedDatePlans = plans.filter(p => {
                const planDate = new Date(p.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = planDate.toISOString().split('T')[0];
                return planDateStr === selectedDateStr;
            });
            
            const completedSelectedDatePlans = selectedDatePlans.filter(p => p.completed).length;
            document.getElementById('today-tasks').textContent = `${completedSelectedDatePlans}/${selectedDatePlans.length}`;
            document.getElementById('today-completion').textContent = selectedDatePlans.length > 0 ? 
                Math.round((completedSelectedDatePlans / selectedDatePlans.length) * 100) + '%' : '0%';
        }

        // 辅助函数
        function getRepeatText(repeat) {
            const repeatMap = {
                'once': '仅当天',
                'daily': '每天',
                'weekdays': '周一至周五',
                'weekly': '每周的这天'
            };
            return repeatMap[repeat] || '仅当天';
        }

        function getSubjectText(subject) {
        const subjectMap = {
            'english': '英语',
            'chinese': '语文',
            'math': '数学',
            'sports': '运动',
            'relax': '放松',
            'skill': '技能',
            'other': '其他'
        };
        return subjectMap[subject] || '其他';
    }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(date) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 格式化日期显示（YYYY/MM/DD）
        function formatDateForDisplay(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

   // 数据模型
        let honors = JSON.parse(localStorage.getItem('studyHonors')) || [];
        let wishes = JSON.parse(localStorage.getItem('studyWishes')) || [];
        let availableStars = parseInt(localStorage.getItem('availableStars')) || 0;
        
        // 初始化默认勋章
        const defaultHonors = [
            // 连续打卡成就
            { id: 1, name: "初级学习者", description: "连续打卡7天", icon: "fas fa-medal", color: "#fd9400", condition: "streak", value: 7, unlocked: false, progress: 0 },
            { id: 2, name: "中级学习者", description: "连续打卡30天", icon: "fas fa-trophy", color: "#4b6bbe", condition: "streak", value: 30, unlocked: false, progress: 0 },
            { id: 3, name: "高级学习者", description: "连续打卡100天", icon: "fas fa-crown", color: "#c690ce", condition: "streak", value: 100, unlocked: false, progress: 0 },
            { id: 4, name: "学习大师", description: "连续打卡365天", icon: "fas fa-award", color: "#28a745", condition: "streak", value: 365, unlocked: false, progress: 0 },
            
            // 累计打卡成就
            { id: 5, name: "入门新手", description: "累计完成10个计划", icon: "fas fa-star", color: "#fd9400", condition: "total_plans", value: 10, unlocked: false, progress: 0 },
            { id: 6, name: "计划达人", description: "累计完成50个计划", icon: "fas fa-trophy", color: "#4b6bbe", condition: "total_plans", value: 50, unlocked: false, progress: 0 },
            { id: 7, name: "计划大师", description: "累计完成100个计划", icon: "fas fa-crown", color: "#c690ce", condition: "total_plans", value: 100, unlocked: false, progress: 0 },
            { id: 8, name: "计划狂人", description: "累计完成500个计划", icon: "fas fa-award", color: "#28a745", condition: "total_plans", value: 500, unlocked: false, progress: 0 },
            
            // 分类打卡成就
            { id: 9, name: "运动新星", description: "总运动完成5个小时", icon: "fas fa-running", color: "#fd9400", condition: "category_hours", category: "sports", value: 5, unlocked: false, progress: 0 },
            { id: 10, name: "运动健将", description: "总运动完成20个小时", icon: "fas fa-trophy", color: "#4b6bbe", condition: "category_hours", category: "sports", value: 20, unlocked: false, progress: 0 },
            { id: 11, name: "运动巨人", description: "总运动完成50个小时", icon: "fas fa-crown", color: "#c690ce", condition: "category_hours", category: "sports", value: 50, unlocked: false, progress: 0 },
            { id: 12, name: "技能达人", description: "完成20个技能计划", icon: "fas fa-paint-brush", color: "#28a745", condition: "category_hours", category: "skill", value: 20, unlocked: false, progress: 0 },
            
            // 时间管理成就
            { id: 13, name: "时间规划者", description: "计划用时与实际用时差在30%以内", icon: "fas fa-clock", color: "#fd9400", condition: "time_accuracy", value: 30, unlocked: false, progress: 0 },
            { id: 14, name: "时间管理者", description: "计划用时与实际用时差在20%以内", icon: "fas fa-trophy", color: "#4b6bbe", condition: "time_accuracy", value: 20, unlocked: false, progress: 0 },
            { id: 15, name: "时间管理大师", description: "计划用时与实际用时差在10%以内", icon: "fas fa-crown", color: "#c690ce", condition: "time_accuracy", value: 10, unlocked: false, progress: 0 },
            
            // 总学习时间成就
            { id: 16, name: "学习新星", description: "总学习时间达到50小时", icon: "fas fa-book", color: "#fd9400", condition: "total_study_hours", value: 50, unlocked: false, progress: 0 },
            { id: 17, name: "学习达人", description: "总学习时间达到100小时", icon: "fas fa-trophy", color: "#4b6bbe", condition: "total_study_hours", value: 100, unlocked: false, progress: 0 },
            { id: 18, name: "学习巨匠", description: "总学习时间达到500小时", icon: "fas fa-crown", color: "#c690ce", condition: "total_study_hours", value: 500, unlocked: false, progress: 0 },
            
            // 提前完成成就
           { id: 19, name: "速度新星", description: "提前10分钟完成", icon: "fas fa-bolt", color: "#fd9400", condition: "early_completion", value: 1, unlocked: false, progress: 0 },
           { id: 20, name: "速度达人", description: "提前20分钟完成", icon: "fas fa-trophy", color: "#4b6bbe", condition: "early_completion", value: 1, unlocked: false, progress: 0 },
            { id: 21, name: "效率大圣", description: "一周内5次提前完成", icon: "fas fa-crown", color: "#c690ce", condition: "early_completion", value: 5, unlocked: false, progress: 0 }
        ];
        
        // 初始化默认兑换清单
        const defaultWishes = [
            { id: 1, category: "entertainment", content: "游戏(30min)", quantity: 1, cost: 10, redeemed: false },
            { id: 2, category: "entertainment", content: "电影", quantity: 1, cost: 15, redeemed: false },
            { id: 3, category: "entertainment", content: "电视(30min)", quantity: 1, cost: 15, redeemed: false },
            { id: 4, category: "food", content: "奶茶(1杯)", quantity: 1, cost: 15, redeemed: false },
            { id: 5, category: "food", content: "蛋糕(1块)", quantity: 1, cost: 20, redeemed: false },
            { id: 6, category: "food", content: "零食", quantity: 1, cost: 10, redeemed: false },
            { id: 7, category: "shopping", content: "书籍", quantity: 1, cost: 15, redeemed: false },
            { id: 8, category: "shopping", content: "文具", quantity: 1, cost: 15, redeemed: false },
            { id: 9, category: "experience", content: "短途旅行", quantity: 1, cost: 50, redeemed: false },
            { id: 10, category: "experience", content: "公园游玩", quantity: 1, cost: 15, redeemed: false }
        ];
        
        // 获取DOM元素
        const honorWallCard = document.getElementById('honor-wall-card');
        const honorModal = document.getElementById('honor-modal');
        const honorBackBtn = document.getElementById('honor-back-btn');
        const addHonorBtn = document.getElementById('add-honor-btn');
        const clearHonorBtn = document.getElementById('clear-honor-btn');
        const addHonorModal = document.getElementById('add-honor-modal');
        const closeAddHonorModal = document.getElementById('close-add-honor-modal');
        const cancelAddHonor = document.getElementById('cancel-add-honor');
        const addHonorForm = document.getElementById('add-honor-form');
        
        const addWishBtn = document.getElementById('add-wish-btn');
        const clearWishBtn = document.getElementById('clear-wish-btn');
        const addWishModal = document.getElementById('add-wish-modal');
        const closeAddWishModal = document.getElementById('close-add-wish-modal');
        const cancelAddWish = document.getElementById('cancel-add-wish');
        const addWishForm = document.getElementById('add-wish-form');
        
        const availableStarsElement = document.getElementById('available-stars');
        const wishCategoryBtns = document.querySelectorAll('.wish-category-btn');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化默认数据
            initializeDefaultData();
            
            // 更新荣誉和星星数据
            updateHonorsAndStars();
            
            // 设置事件监听器
            setupHonorEventListeners();
        });
        
        function initializeDefaultData() {
    // 初始化勋章数据
    if (honors.length === 0) {
        honors = defaultHonors;
    } else {
        // 如果已有勋章数据，更新特定勋章的描述
        const honorUpdates = {
            19: { name: "速度新星", description: "提前10分钟完成" },
            20: { name: "速度达人", description: "提前20分钟完成" },
            21: { name: "效率大圣", description: "一周内5次提前完成" }
        };
        
        honors.forEach(honor => {
            if (honorUpdates[honor.id]) {
                honor.name = honorUpdates[honor.id].name;
                honor.description = honorUpdates[honor.id].description;
            }
        });
    }
    
    // 保存更新后的勋章数据
    localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 初始化兑换清单数据
            if (wishes.length === 0) {
                wishes = defaultWishes;
                localStorage.setItem('studyWishes', JSON.stringify(wishes));
            }
        }
        
        // 设置事件监听器
        function setupHonorEventListeners() {
            // 打开荣誉勋章墙
            honorWallCard.addEventListener('click', function() {
                openHonorModal();
            });
            
            // 返回按钮
            honorBackBtn.addEventListener('click', function() {
                honorModal.style.display = 'none';
            });
            
            // 添加勋章按钮
            addHonorBtn.addEventListener('click', function() {
                addHonorModal.style.display = 'flex';
            });
            
            // 清空勋章按钮
            clearHonorBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有勋章吗？此操作不可撤销！')) {
                    clearAllHonors();
                }
            });
            
            // 关闭添加勋章模态框
            closeAddHonorModal.addEventListener('click', function() {
                addHonorModal.style.display = 'none';
            });
            
            cancelAddHonor.addEventListener('click', function() {
                addHonorModal.style.display = 'none';
            });
            
            // 添加勋章表单提交
            addHonorForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveHonor();
            });
            
            // 添加兑换清单按钮
            addWishBtn.addEventListener('click', function() {
                addWishModal.style.display = 'flex';
            });
            
            // 清空兑换清单按钮
            clearWishBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有兑换清单吗？此操作不可撤销！')) {
                    clearAllWishes();
                }
            });
            
            // 关闭添加兑换清单模态框
            closeAddWishModal.addEventListener('click', function() {
                addWishModal.style.display = 'none';
            });
            
            cancelAddWish.addEventListener('click', function() {
                addWishModal.style.display = 'none';
            });
            
            // 添加兑换清单表单提交
            addWishForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveWish();
            });
            
            // 兑换类别筛选
            wishCategoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    filterWishes(category);
                    
                    // 更新激活状态
                    wishCategoryBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === honorModal) {
                    honorModal.style.display = 'none';
                }
                if (event.target === addHonorModal) {
                    addHonorModal.style.display = 'none';
                }
                if (event.target === addWishModal) {
                    addWishModal.style.display = 'none';
                }
            });
        }
        
        // 打开荣誉勋章墙模态框
        function openHonorModal() {
            // 更新荣誉和星星数据
            updateHonorsAndStars();
            
            // 渲染所有勋章
            renderAllHonors();
            
            // 渲染兑换清单
            renderWishes('all');
            
            // 显示模态框
            honorModal.style.display = 'block';
        }
        
        // 更新荣誉和星星数据
        function updateHonorsAndStars() {
            // 计算连续打卡天数
            const streakDays = calculateStreakDays();
            
            // 计算累计完成计划数
            const totalCompletedPlans = plans.filter(p => p.completed).length;
            
            // 计算分类完成时间
            const categoryHours = calculateCategoryHours();
            
            // 计算时间管理准确率
            const timeAccuracy = calculateTimeAccuracy();
            
            // 计算总学习时间
            const totalStudyHours = calculateTotalStudyHours();
            
            // 计算提前完成次数
            const earlyCompletionCount = calculateEarlyCompletionCount();
            
            // 更新勋章状态
            let newlyUnlockedHonors = [];
            
            honors.forEach(honor => {
                let progress = 0;
                let unlocked = false;
                
                switch (honor.condition) {
                    case 'streak':
                        progress = streakDays;
                        unlocked = streakDays >= honor.value;
                        break;
                    case 'total_plans':
                        progress = totalCompletedPlans;
                        unlocked = totalCompletedPlans >= honor.value;
                        break;
                    case 'category_hours':
                        if (honor.category === 'sports') {
                            progress = categoryHours.sports;
                            unlocked = categoryHours.sports >= honor.value;
                        } else if (honor.category === 'skill') {
                            progress = categoryHours.skill;
                            unlocked = categoryHours.skill >= honor.value;
                        }
                        break;
                    case 'time_accuracy':
                        progress = timeAccuracy;
                        unlocked = timeAccuracy <= honor.value;
                        break;
                    case 'total_study_hours':
                        progress = totalStudyHours;
                        unlocked = totalStudyHours >= honor.value;
                        break;
                    case 'early_completion':
                        progress = earlyCompletionCount;
                        unlocked = earlyCompletionCount >= honor.value;
                        break;
                }
                
                // 检查是否是新解锁的勋章
                if (!honor.unlocked && unlocked) {
                    newlyUnlockedHonors.push(honor);
                }
                
                honor.progress = progress;
                honor.unlocked = unlocked;
            });
            
            // 保存更新后的勋章数据
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 计算星星数量
            calculateStars(newlyUnlockedHonors);
            
            // 更新可用星星显示
            availableStarsElement.textContent = availableStars;
        }
        
        // 计算连续打卡天数
        function calculateStreakDays() {
            const sortedDates = checkins.map(c => c.date).sort();
            let currentStreak = 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            if (sortedDates.includes(todayStr)) {
                currentStreak = 1;
                let currentDate = new Date(today);
                
                for (let i = 1; i <= 365; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const prevDate = currentDate.toISOString().split('T')[0];
                    
                    if (sortedDates.includes(prevDate)) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            return currentStreak;
        }
        
        // 计算分类完成时间
        function calculateCategoryHours() {
            const categoryHours = {
                sports: 0,
                skill: 0
            };
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration) {
                    const durationHours = plan.totalDuration / (1000 * 60 * 60);
                    
                    if (plan.subject === 'sports') {
                        categoryHours.sports += durationHours;
                    } else if (plan.subject === 'skill') {
                        categoryHours.skill += durationHours;
                    }
                }
            });
            
            return categoryHours;
        }
        
        // 计算时间管理准确率
        function calculateTimeAccuracy() {
            let totalPlans = 0;
            let totalAccuracy = 0;
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration && plan.plannedDuration) {
                    const plannedMinutes = parseDuration(plan.plannedDuration);
                    const actualMinutes = plan.totalDuration / (1000 * 60);
                    
                    if (plannedMinutes > 0) {
                        const accuracy = Math.abs(actualMinutes - plannedMinutes) / plannedMinutes * 100;
                        totalAccuracy += accuracy;
                        totalPlans++;
                    }
                }
            });
            
            return totalPlans > 0 ? Math.round(totalAccuracy / totalPlans) : 100;
        }
        
        // 计算总学习时间
        function calculateTotalStudyHours() {
            let totalHours = 0;
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration) {
                    totalHours += plan.totalDuration / (1000 * 60 * 60);
                }
            });
            
            return Math.round(totalHours);
        }
        
        // 计算提前完成次数
        function calculateEarlyCompletionCount() {
            let earlyCompletionCount = 0;
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration && plan.plannedDuration) {
                    const plannedMinutes = parseDuration(plan.plannedDuration);
                    const actualMinutes = plan.totalDuration / (1000 * 60);
                    
                    if (actualMinutes < plannedMinutes) {
                        earlyCompletionCount++;
                    }
                }
            });
            
            return earlyCompletionCount;
        }
        
        // 解析持续时间
        function parseDuration(duration) {
            const parts = duration.split(':');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            return hours * 60 + minutes;
        }
        
        // 计算星星数量
        function calculateStars(newlyUnlockedHonors) {
            // 每完成一个计划获得2颗星
            const completedPlans = plans.filter(p => p.completed).length;
            let starsFromPlans = completedPlans * 2;
            
            // 根据勋章等级获得星星
            let starsFromHonors = 0;
            
            newlyUnlockedHonors.forEach(honor => {
                // 根据勋章难度给予不同数量的星星
                if (honor.value <= 10) {
                    starsFromHonors += 30; // 初级勋章
                } else if (honor.value <= 50) {
                    starsFromHonors += 50; // 中级勋章
                } else if (honor.value <= 100) {
                    starsFromHonors += 80; // 高级勋章
                } else {
                    starsFromHonors += 100; // 高级以上勋章
                }
            });
            
            // 更新可用星星数量
            availableStars = starsFromPlans + starsFromHonors;
            localStorage.setItem('availableStars', availableStars.toString());
        }
        
        // 渲染所有勋章
        function renderAllHonors() {
            renderHonorSection('streak-honor-grid', honors.filter(h => h.condition === 'streak'));
            renderHonorSection('total-honor-grid', honors.filter(h => h.condition === 'total_plans'));
            renderHonorSection('category-honor-grid', honors.filter(h => h.condition === 'category_hours'));
            renderHonorSection('time-management-honor-grid', honors.filter(h => h.condition === 'time_accuracy'));
            renderHonorSection('total-study-honor-grid', honors.filter(h => h.condition === 'total_study_hours'));
            renderHonorSection('early-completion-honor-grid', honors.filter(h => h.condition === 'early_completion'));
        }
        
        // 渲染勋章部分
        function renderHonorSection(sectionId, sectionHonors) {
            const sectionGrid = document.getElementById(sectionId);
            sectionGrid.innerHTML = '';
            
            sectionHonors.forEach(honor => {
                const honorCard = document.createElement('div');
                honorCard.className = `honor-card ${honor.unlocked ? '' : 'locked'}`;
                
                honorCard.innerHTML = `
                    <div class="honor-icon" style="color: ${honor.color}">
                        <i class="${honor.icon}"></i>
                    </div>
                    <div class="honor-name">${honor.name}</div>
                    <div class="honor-description">${honor.description}</div>
                    <div class="honor-progress">进度: ${honor.progress}/${honor.value}</div>
                    ${honor.unlocked ? '<div class="honor-badge"><i class="fas fa-check"></i></div>' : ''}
                `;
                
                sectionGrid.appendChild(honorCard);
            });
        }
        
        // 渲染兑换清单
        function renderWishes(category) {
            const wishGrid = document.getElementById('wish-grid');
            wishGrid.innerHTML = '';
            
            let filteredWishes = wishes;
            
            if (category !== 'all') {
                filteredWishes = wishes.filter(wish => wish.category === category);
            }
            
            filteredWishes.forEach(wish => {
                const wishItem = document.createElement('div');
                wishItem.className = `wish-item ${wish.redeemed ? 'disabled' : ''}`;
                wishItem.setAttribute('data-category', wish.category);

                const categoryNames = {
                    'entertainment': '娱乐活动',
                    'food': '美食饮品',
                    'shopping': '购物奖励',
                    'experience': '体验活动'
                };
                
                wishItem.innerHTML = `
                    <div class="wish-item-header">
                        <div class="wish-item-category">${categoryNames[wish.category]}</div>
                        ${wish.redeemed ? '<div class="wish-item-status">已兑换</div>' : ''}
                    </div>
                    <div class="wish-item-name">${wish.content}</div>
                    <div class="wish-item-description">数量: ${wish.quantity}</div>
                    <div class="wish-item-footer">
                        <div class="wish-item-cost">
                            <i class="fas fa-star"></i>
                            <span>${wish.cost}</span>
                        </div>
                        <button class="wish-item-btn" ${wish.redeemed || availableStars < wish.cost ? 'disabled' : ''}>
                            ${wish.redeemed ? '已兑换' : '兑换'}
                        </button>
                    </div>
                `;
                
                // 添加兑换事件监听器
                const redeemBtn = wishItem.querySelector('.wish-item-btn');
                if (!wish.redeemed && availableStars >= wish.cost) {
                    redeemBtn.addEventListener('click', function() {
                        redeemWish(wish.id);
                    });
                }
                
                wishGrid.appendChild(wishItem);
            });
        }
        
        // 筛选兑换清单
        function filterWishes(category) {
            renderWishes(category);
        }
        
        // 兑换奖励
        function redeemWish(wishId) {
            const wish = wishes.find(w => w.id === wishId);
            
            if (wish && !wish.redeemed && availableStars >= wish.cost) {
                if (confirm(`确定要兑换 ${wish.content} 吗？这将花费 ${wish.cost} 颗星星。`)) {
                    wish.redeemed = true;
                    availableStars -= wish.cost;
                    
                    // 更新本地存储
                    localStorage.setItem('studyWishes', JSON.stringify(wishes));
                    localStorage.setItem('availableStars', availableStars.toString());
                    
                    // 更新UI
                    availableStarsElement.textContent = availableStars;
                    renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
                    
                    alert(`成功兑换 ${wish.content}！`);
                }
            }
        }
        
        // 保存勋章
        function saveHonor() {
            const name = document.getElementById('honor-name').value;
            const description = document.getElementById('honor-description').value;
            const icon = document.getElementById('honor-icon').value;
            const color = document.getElementById('honor-color').value;
            const condition = document.getElementById('honor-condition').value;
            const value = parseInt(document.getElementById('honor-value').value);
            
            const newHonor = {
                id: Date.now(),
                name,
                description,
                icon,
                color,
                condition,
                value,
                unlocked: false,
                progress: 0
            };
            
            honors.push(newHonor);
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 关闭模态框并重置表单
            addHonorModal.style.display = 'none';
            addHonorForm.reset();
            
            // 重新渲染勋章
            renderAllHonors();
            
            alert('勋章添加成功！');
        }
        
        // 保存兑换项
        function saveWish() {
            const category = document.getElementById('wish-category').value;
            const content = document.getElementById('wish-content').value;
            const quantity = parseInt(document.getElementById('wish-quantity').value);
            const cost = parseInt(document.getElementById('wish-cost').value);
            
            const newWish = {
                id: Date.now(),
                category,
                content,
                quantity,
                cost,
                redeemed: false
            };
            
            wishes.push(newWish);
            localStorage.setItem('studyWishes', JSON.stringify(wishes));
            
            // 关闭模态框并重置表单
            addWishModal.style.display = 'none';
            addWishForm.reset();
            
            // 重新渲染兑换清单
            renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
            
            alert('兑换项添加成功！');
        }
        
        // 清空所有勋章
        function clearAllHonors() {
            honors = [];
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 重新渲染勋章
            renderAllHonors();
            
            alert('所有勋章已清空！');
        }
        
        // 清空所有兑换清单
        function clearAllWishes() {
            wishes = [];
            localStorage.setItem('studyWishes', JSON.stringify(wishes));
            
            // 重新渲染兑换清单
            renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
            
            alert('所有兑换清单已清空！');
        }
    </script>
</body>
</html>